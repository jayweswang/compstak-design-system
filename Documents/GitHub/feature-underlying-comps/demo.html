<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CompStak - Transaction Details</title>
    <style>
        /* Design System CSS Variables */
        :root {
            /* Colors - Primitives */
            --color-neutral-0: #FFFFFF;
            --color-neutral-10: #F8F8F8;
            --color-neutral-20: #F4F5F7;
            --color-neutral-30: #EBECF0;
            --color-neutral-50: #C1C7D0;
            --color-neutral-70: #A8B0BE;
            --color-neutral-100: #606581;
            --color-neutral-600: #303441;
            --color-neutral-800: #262931;
            
            --color-blue-500: #228FFF;
            --color-blue-600: #257FF6;
            --color-blue-700: #1E71ED;
            --color-blue-10: #F2F8FF;
            --color-blue-20: #EBF4FF;
            
            --color-green-500: #6CB584;
            --color-red-500: #BF2600;
            --color-yellow-500: #FCC637;
            --color-violet-400: #8B5CF6;
            --color-pink-500: #E91E8C;
            
            /* Semantic Colors */
            --color-content-primary-text: var(--color-neutral-600);
            --color-content-secondary-text: var(--color-neutral-100);
            --color-content-tertiary-text: var(--color-neutral-70);
            --color-content-primary-border: var(--color-neutral-100);
            --color-content-secondary-border: var(--color-neutral-30);
            --color-content-tertiary-border: var(--color-neutral-50);
            
            --color-action-primary: var(--color-blue-500);
            --color-action-primary-hover: var(--color-blue-600);
            --color-action-primary-pressed: var(--color-blue-700);
            
            --color-surface-canvas: var(--color-neutral-0);
            --color-surface-raised: var(--color-neutral-10);
            --color-surface-subtle: var(--color-neutral-30);
            --color-surface-interactive-default: var(--color-neutral-0);
            --color-surface-interactive-hover: var(--color-blue-10);
            --color-surface-interactive-selected: var(--color-blue-20);
            
            /* Spacing */
            --space-0: 0;
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            
            /* Typography */
            --font-family-text: 'Gotham', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-family-numeric: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            
            --font-size-1: 0.75rem;
            --font-size-2: 0.875rem;
            --font-size-3: 1rem;
            --font-size-4: 1.25rem;
            --font-size-5: 1.5rem;
            --font-size-6: 1.75rem;
            --font-size-7: 2rem;
            
            --line-height-1: 1rem;
            --line-height-2: 1.25rem;
            --line-height-3: 1.5rem;
            --line-height-4: 1.75rem;
            --line-height-5: 2rem;
            
            --font-weight-400: 400;
            --font-weight-600: 600;
            --font-weight-700: 700;
            
            --letter-spacing-1: -0.16em;
            --letter-spacing-2: 0;
            --letter-spacing-3: 0.32em;
            
            /* Heading styles (type/heading/*). Prefer over display for product UI; less bold. See typography.rules.mdc. */
            --type-heading-lg-size: var(--font-size-5);
            --type-heading-lg-weight: var(--font-weight-600);
            --type-heading-md-size: var(--font-size-4);
            --type-heading-md-weight: var(--font-weight-600);
            --type-heading-sm-size: var(--font-size-3);
            --type-heading-sm-weight: var(--font-weight-600);
            
            /* Radius */
            --radius-xs: var(--space-1);
            --radius-sm: var(--space-2);
            --radius-md: var(--space-3);
            --radius-lg: var(--space-4);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            height: 100%;
        }
        
        body {
            font-family: var(--font-family-text);
            font-size: var(--font-size-3);
            line-height: var(--line-height-3);
            color: var(--color-content-primary-text);
            background: var(--color-surface-canvas);
            display: flex;
            flex-direction: column;
            min-height: 100%;
            padding-top: 56px;
        }
        
        /* Top Navigation Bar */
        .top-nav {
            background: var(--color-neutral-800);
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-6);
            color: var(--color-neutral-0);
            flex-shrink: 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        .top-nav-left {
            display: flex;
            align-items: center;
            gap: var(--space-6);
        }
        
        .logo {
            font-size: var(--font-size-5);
            font-weight: var(--type-heading-lg-weight);
            color: var(--color-neutral-0);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .nav-links {
            display: flex;
            gap: var(--space-4);
            align-items: center;
        }
        
        .nav-link {
            color: var(--color-neutral-0);
            text-decoration: none;
            font-size: var(--font-size-2);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-xs);
            transition: background 0.2s;
            text-transform: uppercase;
            font-weight: var(--font-weight-600);
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .nav-separator {
            color: var(--color-neutral-50);
            font-size: var(--font-size-2);
        }
        
        .top-nav-right {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }
        
        .invite-button {
            background: var(--color-blue-500);
            color: var(--color-neutral-0);
            border: none;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-xs);
            font-size: var(--font-size-2);
            font-weight: var(--font-weight-600);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .invite-button:hover {
            background: var(--color-blue-600);
        }
        
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--color-blue-500);
            color: var(--color-neutral-0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-600);
            font-size: var(--font-size-2);
        }
        
        /* Main Layout Container */
        .main-layout {
            display: flex;
            flex: 1;
            min-height: 0;
        }
        
        /* Left Side Navigation */
        .side-nav {
            width: 320px;
            background: var(--color-surface-canvas);
            border-right: 1px solid var(--color-content-secondary-border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            position: relative;
        }
        
        .side-nav-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--color-content-secondary-border);
        }
        
        .side-nav-location-label {
            font-size: var(--font-size-2);
            color: var(--color-content-secondary-text);
            margin-bottom: var(--space-1);
            text-transform: uppercase;
        }
        
        .side-nav-property-address {
            font-size: var(--type-heading-lg-size);
            font-weight: var(--type-heading-lg-weight);
            color: var(--color-action-primary);
            text-decoration: underline;
            margin-bottom: var(--space-2);
            cursor: pointer;
        }
        
        .side-nav-address-details {
            font-size: var(--font-size-2);
            color: var(--color-content-secondary-text);
            margin-bottom: var(--space-4);
        }
        
        .side-nav-attributes {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-4);
            font-size: var(--font-size-2);
        }
        
        .side-nav-attribute-item {
            display: flex;
            gap: var(--space-2);
        }
        
        .side-nav-attribute-label {
            color: var(--color-content-secondary-text);
            font-weight: var(--font-weight-600);
        }
        
        .side-nav-attribute-value {
            color: var(--color-content-primary-text);
        }
        
        .property-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-bottom: 1px solid var(--color-content-secondary-border);
        }
        
        .property-details {
            padding: var(--space-6);
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }
        
        .property-detail-row {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }
        
        .property-detail-label {
            font-size: var(--font-size-2);
            color: var(--color-content-secondary-text);
            font-weight: var(--font-weight-600);
        }
        
        .property-detail-value {
            font-size: var(--font-size-3);
            color: var(--color-content-primary-text);
        }
        
        /* Right Content Area */
        .right-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        /* Hero Section */
        .hero-section {
            padding: var(--space-6);
            border-bottom: 1px solid var(--color-content-secondary-border);
            background: var(--color-surface-canvas);
        }
        
        .hero-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .transaction-summary {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: var(--space-4);
            width: 100%;
        }
        
        .verification-badge {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--font-size-2);
            color: var(--color-content-secondary-text);
            background: var(--color-surface-raised);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-sm);
        }
        
        .verification-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--color-content-primary-text);
            color: var(--color-neutral-0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-600);
            font-size: var(--font-size-2);
        }
        
        .suggest-update-button {
            background: var(--color-surface-canvas);
            border: 1px solid var(--color-content-secondary-border);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-2);
            color: var(--color-content-primary-text);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .suggest-update-button:hover {
            background: var(--color-surface-raised);
        }
        
        .transaction-title {
            font-size: var(--type-heading-md-size);
            font-weight: var(--type-heading-md-weight);
            margin-bottom: var(--space-4);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .transaction-title .compstak-link {
            color: var(--color-action-primary);
            text-decoration: none;
        }
        
        .transaction-title-text {
            color: var(--color-content-primary-text);
        }
        
        .transaction-details-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: var(--space-4);
            font-size: var(--font-size-2);
        }
        
        .transaction-detail-item {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }
        
        .transaction-detail-label {
            color: var(--color-content-secondary-text);
            font-weight: var(--font-weight-600);
        }
        
        .transaction-detail-value {
            color: var(--color-content-primary-text);
        }
        
        .transaction-detail-appendage {
            color: var(--color-content-secondary-text);
            font-weight: var(--font-weight-400);
            font-size: var(--font-size-1);
        }
        
        .est-rent-detail-item {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }
        
        .est-rent-detail-label {
            color: var(--color-violet-400);
            font-weight: var(--font-weight-600);
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }
        
        .est-rent-detail-value {
            color: var(--color-content-primary-text);
            font-weight: var(--font-weight-600);
        }
        
        .est-rent-detail-appendage {
            color: var(--color-content-secondary-text);
            font-size: var(--font-size-1);
        }
        
        .est-rent-detail-appendage .green-value {
            color: var(--color-green-500);
        }
        
        .est-rent-calculated-note {
            color: var(--color-content-secondary-text);
            font-size: var(--font-size-1);
            margin-top: var(--space-1);
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }
        
        .comps-link {
            color: var(--color-action-primary);
            text-decoration: none;
            cursor: pointer;
        }
        
        .comps-link:hover {
            text-decoration: underline;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: row;
            gap: var(--space-2);
        }
        
        .action-button {
            background: transparent;
            border: 1px solid var(--color-action-primary);
            color: var(--color-action-primary);
            cursor: pointer;
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--font-size-2);
            transition: all 0.2s;
        }
        
        .action-button:hover {
            background: var(--color-surface-interactive-hover);
        }
        
        .action-button.primary {
            background: var(--color-action-primary);
            color: var(--color-neutral-0);
            border-color: var(--color-action-primary);
        }
        
        .action-button.primary:hover {
            background: var(--color-action-primary-hover);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: var(--space-2);
            border-bottom: 1px solid var(--color-content-secondary-border);
            padding: 0 var(--space-6);
            background: var(--color-surface-canvas);
            flex-shrink: 0;
        }
        
        .tab {
            padding: var(--space-3) var(--space-4);
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            font-family: var(--font-family-text);
            font-size: var(--font-size-2);
            font-weight: var(--font-weight-600);
            color: var(--color-content-secondary-text);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            bottom: -1px;
        }
        
        .tab:hover {
            color: var(--color-content-primary-text);
            background: var(--color-surface-interactive-hover);
        }
        
        .tab.active {
            color: var(--color-action-primary);
            border-bottom-color: var(--color-action-primary);
        }
        
        /* AI tabs (Rent Calculation and Estimation Summary) use violet style */
        .tab[data-tab="underlying-comps"].active,
        .tab[data-tab="estimated-summary"].active {
            color: var(--color-violet-400);
            border-bottom-color: var(--color-violet-400);
        }
        
        /* Tab Content Area */
        .tab-content-wrapper {
            flex: 1;
            padding: var(--space-6);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Content Layout */
        .content-layout {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: var(--space-8);
        }
        
        .content-column {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }
        
        .section {
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        
        .section-title {
            font-size: var(--type-heading-md-size);
            font-weight: var(--type-heading-md-weight);
            color: var(--color-content-primary-text);
            margin-bottom: var(--space-2);
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: var(--space-1) 0;
            border-bottom: 1px solid var(--color-content-tertiary-border);
            font-size: var(--font-size-2);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            color: var(--color-content-secondary-text);
            font-weight: var(--font-weight-600);
        }
        
        .detail-value {
            color: var(--color-content-primary-text);
            text-align: right;
            flex: 1;
            margin-left: var(--space-4);
        }
        
        .detail-value a {
            color: var(--color-action-primary);
            text-decoration: none;
        }
        
        .detail-value a:hover {
            text-decoration: underline;
        }
        
        .highlight-value {
            color: var(--color-action-primary);
            font-weight: var(--font-weight-600);
        }
        
        .purple-label {
            color: var(--color-violet-400);
            font-weight: var(--font-weight-600);
        }
        
        .info-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--color-content-tertiary-border);
            color: var(--color-content-primary-text);
            font-size: var(--font-size-1);
            text-align: center;
            line-height: 16px;
            margin-left: var(--space-1);
            cursor: help;
        }
        
        .notes-text {
            font-size: var(--font-size-2);
            color: var(--color-content-primary-text);
            line-height: var(--line-height-3);
            padding: var(--space-3);
            background: var(--color-surface-raised);
            border-radius: var(--radius-sm);
        }
        
        .data-provider-note {
            font-size: var(--font-size-1);
            color: var(--color-content-tertiary-text);
            margin-top: var(--space-2);
            font-style: italic;
        }
        
        /* Underlying Comps Section */
        .underlying-comps-header {
            margin-bottom: var(--space-6);
        }
        
        .underlying-comps-title {
            font-size: var(--type-heading-lg-size);
            font-weight: var(--type-heading-lg-weight);
            color: var(--color-content-primary-text);
            margin-bottom: var(--space-1);
        }
        
        .underlying-comps-subtitle {
            font-size: var(--font-size-2);
            color: var(--color-content-secondary-text);
        }
        
        /* Map Container */
        .map-container {
            width: 100%;
            height: 400px;
            background: var(--color-surface-raised);
            border: 1px solid var(--color-content-secondary-border);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-6);
            position: relative;
            overflow: hidden;
        }
        
        .map-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            border-radius: 0;
            margin-bottom: 0;
        }
        
        .map-fullscreen-button {
            position: absolute;
            top: var(--space-4);
            left: var(--space-4);
            z-index: 1002;
            background: var(--color-neutral-0);
            border: 1px solid var(--color-content-secondary-border);
            border-radius: var(--radius-sm);
            padding: var(--space-2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        
        .map-fullscreen-button:hover {
            background: var(--color-surface-raised);
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
        }
        
        .map-fullscreen-button svg {
            width: 18px;
            height: 18px;
            fill: var(--color-content-primary-text);
        }
        
        .map-reset-view-button {
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            z-index: 1002;
            background: var(--color-neutral-0);
            border: 1px solid var(--color-content-secondary-border);
            border-radius: var(--radius-sm);
            padding: var(--space-2) var(--space-3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-1);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s;
            font-size: var(--font-size-2);
            font-weight: var(--font-weight-600);
            color: var(--color-content-primary-text);
            font-family: var(--font-family-text);
        }
        
        .map-reset-view-button:hover {
            background: var(--color-surface-raised);
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
        }
        
        .map-reset-view-button svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
        }
        
        /* Map Callout */
        .map-callout {
            position: absolute;
            bottom: var(--space-4);
            right: var(--space-4);
            max-width: 450px;
            background: var(--color-neutral-800);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
        }
        
        .map-callout.visible {
            display: block;
        }
        
        .map-callout-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-2);
        }
        
        .map-callout-address-section {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: var(--space-3);
            flex: 1;
        }
        
        .map-callout-pin-indicator {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }
        
        .map-callout-pin-indicator svg {
            width: 24px;
            height: 30px;
        }
        
        .map-callout-address-wrapper {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
            flex: 1;
        }
        
        .map-callout-address {
            font-size: var(--type-heading-sm-size);
            font-weight: var(--type-heading-sm-weight);
            color: var(--color-neutral-0);
        }
        
        .map-callout-location {
            font-size: var(--font-size-1);
            color: var(--color-neutral-70);
        }
        
        .map-callout-close {
            background: transparent;
            border: none;
            color: var(--color-neutral-0);
            font-size: var(--font-size-2);
            cursor: pointer;
            padding: var(--space-1);
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: opacity 0.2s;
            flex-shrink: 0;
        }
        
        .map-callout-close:hover {
            opacity: 1;
        }
        
        .map-callout-content {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }
        
        .map-callout-type-info {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--font-size-1);
        }
        
        .map-callout-type-info span {
            color: var(--color-blue-500);
        }
        
        .map-callout-type-info .separator {
            color: var(--color-blue-500);
            opacity: 0.5;
        }
        
        .map-callout-type-info .size {
            color: var(--color-neutral-0);
        }
        
        .map-callout-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-2);
        }
        
        .map-callout-metric {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }
        
        .map-callout-metric-label {
            font-size: var(--font-size-1);
            color: var(--color-neutral-70);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .map-callout-metric-value {
            font-size: var(--font-size-2);
            font-weight: var(--font-weight-600);
            color: var(--color-neutral-0);
            font-family: var(--font-family-numeric);
        }
        
        .map-callout-actions {
            display: flex;
            gap: var(--space-2);
            align-items: center;
            margin-top: var(--space-1);
        }
        
        .map-callout-button {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            border: none;
            font-size: var(--font-size-1);
            font-weight: var(--font-weight-600);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .map-callout-button.primary {
            background: var(--color-blue-500);
            color: var(--color-neutral-0);
        }
        
        .map-callout-button.primary:hover {
            background: var(--color-blue-600);
        }
        
        .map-callout-button.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--color-neutral-0);
        }
        
        .map-callout-button.secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        
        .map-container .leaflet-container {
            font-family: var(--font-family-text);
            background: var(--color-surface-raised);
        }
        
        .map-container .leaflet-tile-pane {
            opacity: 0.6;
        }
        
        .map-container .leaflet-control-zoom {
            border: 1px solid var(--color-content-secondary-border);
            border-radius: var(--radius-sm);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 60px !important;
            margin-left: var(--space-4) !important;
        }
        
        .map-container .leaflet-control-zoom a {
            background: var(--color-neutral-0);
            color: var(--color-content-primary-text);
            border: none;
            width: 32px;
            height: 32px;
            line-height: 32px;
            font-size: 18px;
            font-weight: var(--font-weight-600);
        }
        
        .map-container .leaflet-control-zoom a:hover {
            background: var(--color-surface-interactive-hover);
        }
        
        .map-container .leaflet-control-zoom-in,
        .map-container .leaflet-control-zoom-out {
            border-bottom: 1px solid var(--color-content-secondary-border);
        }
        
        .map-container .leaflet-control-zoom-out {
            border-bottom: none;
        }
        
        .comps-custom-marker {
            background: none !important;
            border: none !important;
        }
        
        /* Modal Dialog */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.visible {
            display: flex;
        }
        
        .modal-dialog {
            background: var(--color-neutral-0);
            border-radius: var(--radius-md);
            padding: var(--space-6);
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }
        
        .modal-title {
            font-size: var(--type-heading-lg-size);
            font-weight: var(--type-heading-lg-weight);
            color: var(--color-content-primary-text);
        }
        
        .modal-close {
            background: transparent;
            border: none;
            color: var(--color-content-secondary-text);
            font-size: var(--font-size-4);
            cursor: pointer;
            padding: var(--space-1);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            background: var(--color-surface-interactive-hover);
            color: var(--color-content-primary-text);
        }
        
        .modal-body {
            font-size: var(--font-size-3);
            color: var(--color-content-primary-text);
            line-height: var(--line-height-3);
        }
        
        .comps-map-legend {
            position: absolute;
            bottom: var(--space-4);
            left: var(--space-4);
            z-index: 1001;
            background: var(--color-neutral-0);
            border: 1px solid var(--color-content-secondary-border);
            border-radius: var(--radius-sm);
            padding: var(--space-2) var(--space-3);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            width: fit-content;
            max-width: fit-content;
        }
        
        .comps-map-legend-title {
            font-size: var(--font-size-1);
            font-weight: var(--font-weight-600);
            color: var(--color-content-primary-text);
            margin-bottom: var(--space-1);
        }
        
        .comps-map-legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--font-size-1);
            color: var(--color-content-primary-text);
            margin-bottom: var(--space-1);
        }
        
        .comps-map-legend-item:last-child {
            margin-bottom: 0;
        }
        
        .comps-map-legend-item svg {
            width: 16px;
            height: 20px;
        }
        
        .comps-map-pin {
            width: 20px;
            height: 26px;
            flex-shrink: 0;
        }
        
        .map-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-content-tertiary-text);
            background: linear-gradient(135deg, var(--color-surface-raised) 0%, var(--color-surface-subtle) 100%);
        }
        
        /* Comps Table - Property-grouped */
        .comps-table-wrapper {
            margin-bottom: var(--space-6);
        }
        
        .comps-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .comps-table thead {
            background: var(--color-surface-raised);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .comps-table th,
        .comps-table td {
            padding: var(--space-3) var(--space-4);
            text-align: left;
            border-bottom: 1px solid var(--color-content-tertiary-border);
            font-size: var(--font-size-2);
            vertical-align: middle;
        }
        
        .comps-table .adjustment-cell {
            padding-left: var(--space-6);
            padding-right: var(--space-6);
        }
        
        .adjustment-amount-tertiary {
            color: var(--color-content-tertiary-text);
            font-size: var(--font-size-1);
        }
        
        .comps-table .lease-row.has-expanded-breakdown td {
            border-bottom: none;
        }
        
        .comps-table th {
            font-weight: var(--font-weight-600);
            color: var(--color-content-primary-text);
            position: relative;
            user-select: none;
        }
        
        .comps-table th.sortable {
            cursor: pointer;
            padding-right: var(--space-8);
        }
        
        .comps-table th.sortable:hover {
            background: var(--color-surface-interactive-hover);
        }
        
        .comps-table th .sort-indicator {
            position: absolute;
            right: var(--space-2);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-content-secondary-text);
            font-size: var(--font-size-1);
        }
        
        .comps-table th.sort-asc .sort-indicator::after {
            content: '↑';
            color: var(--color-action-primary);
        }
        
        .comps-table th.sort-desc .sort-indicator::after {
            content: '↓';
            color: var(--color-action-primary);
        }
        
        .comps-table td {
            color: var(--color-content-primary-text);
        }
        
        .comps-table .numeric {
            font-family: var(--font-family-numeric);
            text-align: right;
        }
        
        .comps-table .change-positive {
            color: var(--color-green-500);
        }
        
        .comps-table .change-negative {
            color: var(--color-red-500);
        }
        
        .comps-table .address-cell {
            font-weight: var(--font-weight-400);
        }
        
        .comps-table .subject-tenant {
            font-weight: var(--font-weight-600);
        }
        
        .comps-table .address-with-pin {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .comps-table .lease-row .address-cell:empty {
            padding: var(--space-3) var(--space-4);
        }
        
        .comps-table.sorted .lease-row .address-cell {
            padding: var(--space-3) var(--space-4);
        }
        
        /* Property Group Styling */
        .comps-table .property-group.group-start {
            border-top: 2px solid var(--color-content-secondary-border);
        }
        
        .comps-table .property-group.group-end {
            border-bottom: 2px solid var(--color-content-secondary-border);
        }
        
        .comps-table .property-group:not(.group-start) td {
            border-top: 1px solid var(--color-content-tertiary-border);
            border-top-color: rgba(193, 199, 208, 0.3);
        }
        
        .comps-table .adjustment-breakdown-row.property-group {
            background: var(--color-surface-canvas);
        }
        
        .comps-table .est-rent-cell {
            color: var(--color-violet-400);
            font-weight: var(--font-weight-600);
        }
        
        .comps-table .subject-tag {
            display: inline-block;
            background: var(--color-pink-500);
            color: var(--color-neutral-0);
            font-size: var(--font-size-1);
            font-weight: var(--font-weight-600);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-xs);
            margin-left: var(--space-2);
        }
        
        .see-why-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            background: transparent;
            border: 1px solid var(--color-action-primary);
            color: var(--color-action-primary);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-2);
            font-family: var(--font-family-text);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .see-why-btn:hover {
            background: var(--color-surface-interactive-hover);
        }
        
        .see-why-btn.expanded {
            background: var(--color-surface-interactive-selected);
        }
        
        .see-why-btn.expanded span:last-child {
            transform: rotate(180deg);
        }
        
        /* Adjustment Breakdown Table */
        .adjustment-breakdown-row {
            display: none;
        }
        
        .adjustment-breakdown-row.expanded {
            display: table-row;
        }
        
        .adjustment-breakdown-row td {
            border-top: none !important;
        }
        
        .adjustment-breakdown-cell {
            padding: var(--space-4) var(--space-6) !important;
            border-bottom: none !important;
            border-top: none !important;
            background: var(--color-neutral-0) !important;
        }
        
        .adjustment-breakdown-wrapper {
            padding-left: var(--space-6);
        }
        
        .adjustment-breakdown-title {
            font-size: var(--type-heading-md-size);
            font-weight: var(--type-heading-md-weight);
            color: var(--color-content-primary-text);
            margin-bottom: var(--space-3);
        }
        
        .adjustment-breakdown-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--color-neutral-0);
            border: none;
            margin: 0;
        }
        
        .adjustment-breakdown-table thead {
            background: var(--color-surface-raised);
        }
        
        .adjustment-breakdown-table th {
            padding: var(--space-3) var(--space-4);
            text-align: left;
            font-weight: var(--font-weight-600);
            color: var(--color-content-primary-text);
            font-size: var(--font-size-2);
            border-bottom: 1px solid var(--color-content-tertiary-border);
        }
        
        .adjustment-breakdown-table th:nth-child(4) {
            text-align: right;
        }
        
        .adjustment-breakdown-table tbody tr {
            border-bottom: 1px solid rgba(193, 199, 208, 0.3);
            background: var(--color-neutral-0);
        }
        
        .adjustment-breakdown-table tbody tr:last-child {
            border-bottom: none;
        }
        
        .adjustment-breakdown-table td {
            padding: var(--space-3) var(--space-4);
            color: var(--color-content-secondary-text);
            font-size: var(--font-size-2);
            background: var(--color-neutral-0);
        }
        
        .adjustment-breakdown-table td:nth-child(2),
        .adjustment-breakdown-table td:nth-child(3) {
            color: var(--color-content-secondary-text);
        }
        
        .adjustment-breakdown-table td:nth-child(4) {
            text-align: right;
            font-family: var(--font-family-numeric);
            color: var(--color-content-primary-text);
        }
        
        .adjustment-breakdown-table .adjustment-label {
            color: var(--color-content-primary-text);
            font-weight: var(--font-weight-400);
        }
        
        .adjustment-breakdown-table .adjustment-value {
            color: var(--color-content-primary-text);
            font-family: var(--font-family-numeric);
        }
        
        .adjustment-breakdown-table tbody tr:last-child {
            border-top: 1px solid var(--color-content-tertiary-border);
        }
        
        .adjustment-breakdown-table tbody tr:last-child td {
            font-weight: var(--font-weight-600);
            color: var(--color-content-primary-text);
        }
        
        .adjustment-breakdown-table .final-row {
            background: rgba(139, 92, 246, 0.1);
        }
        
        .adjustment-breakdown-table .final-row .adjustment-label {
            color: var(--color-violet-400);
            font-weight: var(--font-weight-600);
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }
        
        .adjustment-breakdown-table .final-row .adjustment-label-main {
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }
        
        .adjustment-breakdown-table .final-row .adjustment-label-calc {
            font-size: var(--font-size-1);
            color: var(--color-content-secondary-text);
            font-weight: var(--font-weight-400);
        }
        
        .adjustment-breakdown-table .final-row .adjustment-value {
            color: var(--color-violet-400);
            font-weight: var(--font-weight-600);
        }
        
        /* Pagination */
        .comps-pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-4) 0;
        }
        
        .comps-pagination-btn {
            background: var(--color-surface-canvas);
            border: 1px solid var(--color-content-secondary-border);
            color: var(--color-content-primary-text);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-2);
            font-family: var(--font-family-text);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .comps-pagination-btn:hover:not(:disabled) {
            background: var(--color-surface-interactive-hover);
        }
        
        .comps-pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .comps-pagination-pages {
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }
        
        .comps-pagination-page {
            min-width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-2);
            font-weight: var(--font-weight-600);
            color: var(--color-content-primary-text);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .comps-pagination-page:hover {
            background: var(--color-surface-interactive-hover);
        }
        
        .comps-pagination-page.active {
            background: var(--color-surface-interactive-selected);
            color: var(--color-action-primary);
        }
        
        /* Dashboard Cards */
        .dashboard-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: var(--space-6);
        }
        
        .dashboard-card {
            background: var(--color-surface-raised);
            border: 1px solid var(--color-content-secondary-border);
            border-radius: var(--radius-md);
            padding: var(--space-6);
        }
        
        .dashboard-card-header {
            font-size: var(--font-size-2);
            font-weight: var(--font-weight-600);
            color: var(--color-content-secondary-text);
            margin-bottom: var(--space-4);
        }
        
        .dashboard-card-value {
            font-size: var(--type-heading-lg-size);
            font-weight: var(--type-heading-lg-weight);
            font-family: var(--font-family-numeric);
            color: var(--color-content-primary-text);
            line-height: var(--line-height-4);
            letter-spacing: var(--letter-spacing-2);
        }
        
        .dashboard-card-label {
            font-size: var(--font-size-2);
            color: var(--color-content-tertiary-text);
            margin-top: var(--space-2);
        }
        
        .dashboard-card-tag {
            display: inline-block;
            padding: var(--space-1) var(--space-2);
            background: var(--color-yellow-500);
            color: var(--color-neutral-800);
            border-radius: var(--radius-xs);
            font-size: var(--font-size-1);
            font-weight: var(--font-weight-600);
            margin-top: var(--space-2);
        }
        
        .dashboard-card-full {
            grid-column: 1 / -1;
        }

        /* Estimated Summary tab: two-column layout */
        .estimated-summary-layout {
            display: grid;
            grid-template-columns: 1fr 1.25fr;
            gap: var(--space-4);
            align-items: start;
        }

        .estimated-summary-left-column {
            display: flex;
            flex-direction: column;
            gap: var(--space-6);
        }

        .estimated-summary-right-column {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .estimated-summary-layout .dashboard-card {
            width: 100%;
        }
        
        .market-rent-graph-card {
            padding-top: var(--space-4);
        }

        /* Est. Starting Rent Today Card */
        .est-starting-rent-card {
            padding: var(--space-6);
        }

        .est-rent-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
        }

        .est-rent-title {
            font-size: var(--type-heading-md-size);
            font-weight: var(--type-heading-md-weight);
            color: var(--color-content-primary-text);
        }
        
        .est-summary-card .est-rent-title {
            font-size: var(--type-heading-md-size);
            margin-bottom: var(--space-3);
        }
        
        .est-summary-section-title {
            font-size: var(--type-heading-md-size);
            font-weight: var(--type-heading-md-weight);
            color: var(--color-content-primary-text);
            margin-bottom: var(--space-3);
        }

        .est-rent-icon {
            font-size: var(--font-size-3);
            opacity: 0.7;
        }

        .est-rent-separator {
            height: 1px;
            background: var(--color-violet-400);
            opacity: 0.3;
            margin-bottom: var(--space-4);
        }

        .est-rent-data-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3) 0;
        }

        .est-rent-label {
            font-size: var(--font-size-2);
            color: var(--color-content-secondary-text);
            text-align: left;
        }

        .est-rent-value {
            font-size: var(--font-size-2);
            font-weight: var(--font-weight-600);
            color: var(--color-violet-400);
            text-align: right;
            font-family: var(--font-family-numeric);
        }

        .est-rent-value-secondary {
            font-size: var(--font-size-2);
            color: var(--color-content-secondary-text);
            text-align: right;
        }

        .est-rent-data-separator {
            height: 1px;
            background: var(--color-content-tertiary-border);
            margin: var(--space-2) 0;
        }
        
        /* Sticky Est. Starting Rent Today Card in Left Panel */
        .sticky-est-rent-card {
            position: sticky;
            top: var(--space-4);
            bottom: var(--space-4);
            margin: var(--space-4);
            padding: var(--space-5);
            background: #F8F8FC;
            border: 1px solid var(--color-content-secondary-border);
            border-radius: var(--radius-sm);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: none;
            z-index: 10;
            max-height: calc(100vh - var(--space-4) * 2 - 56px);
            overflow-y: auto;
        }
        
        .sticky-est-rent-card.visible {
            display: block;
        }
        
        .sticky-est-rent-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-4);
            position: relative;
        }
        
        .sticky-est-rent-title-wrapper {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            flex: 1;
            min-width: 0;
        }
        
        .sticky-est-rent-title {
            font-size: var(--font-size-3);
            font-weight: var(--font-weight-600);
            color: var(--color-violet-400);
            display: flex;
            align-items: center;
            gap: var(--space-1);
            white-space: nowrap;
        }
        
        .sticky-est-rent-info-icon {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--color-content-tertiary-border);
            color: var(--color-content-secondary-text);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: var(--font-weight-600);
            cursor: pointer;
            margin-left: var(--space-1);
        }
        
        .sticky-est-rent-action-icon {
            width: 24px;
            height: 24px;
            border: 1px solid var(--color-blue-500);
            border-radius: var(--radius-xs);
            background: transparent;
            color: var(--color-blue-500);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            padding: 2px;
        }
        
        .sticky-est-rent-action-icon svg {
            width: 100%;
            height: 100%;
        }
        
        .sticky-est-rent-main-value {
            display: flex;
            align-items: baseline;
            gap: var(--space-2);
            margin-bottom: var(--space-2);
            flex-wrap: wrap;
        }
        
        .sticky-est-rent-value {
            font-size: var(--type-heading-lg-size);
            font-weight: var(--type-heading-lg-weight);
            color: var(--color-content-primary-text);
            font-family: var(--font-family-numeric);
        }
        
        .sticky-est-rent-annotation {
            font-size: var(--font-size-2);
            color: var(--color-content-primary-text);
            font-weight: var(--font-weight-400);
        }
        
        .sticky-est-rent-separator {
            font-size: var(--font-size-2);
            color: var(--color-content-primary-text);
        }
        
        .sticky-est-rent-percentage {
            font-size: var(--font-size-2);
            color: var(--color-green-500);
            font-weight: var(--font-weight-600);
            font-family: var(--font-family-numeric);
        }
        
        .sticky-est-rent-comparison {
            font-size: var(--font-size-2);
            color: var(--color-content-secondary-text);
            margin-bottom: var(--space-3);
        }
        
        .sticky-est-rent-comparison .comparison-value {
            color: var(--color-content-primary-text);
        }
        
        .sticky-est-rent-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3) 0;
            border-bottom: 1px solid var(--color-content-tertiary-border);
        }
        
        .sticky-est-rent-detail-row:last-child {
            border-bottom: none;
        }
        
        .sticky-est-rent-detail-label {
            font-size: var(--font-size-2);
            color: var(--color-content-secondary-text);
        }
        
        .sticky-est-rent-detail-value {
            font-size: var(--font-size-2);
            color: var(--color-content-primary-text);
            font-weight: var(--font-weight-600);
        }
        
        .sticky-est-rent-button {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            background: var(--color-violet-400);
            color: var(--color-neutral-0);
            border: none;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-2);
            font-weight: var(--font-weight-600);
            cursor: pointer;
            transition: background 0.2s;
            margin-top: var(--space-4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
        }
        
        .sticky-est-rent-button:hover {
            background: var(--color-violet-600);
        }

        .est-summary-description {
            font-size: var(--font-size-2);
            color: var(--color-content-secondary-text);
            line-height: var(--line-height-3);
            margin-bottom: var(--space-5);
        }

        .est-summary-value-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
        }

        .est-summary-value-large {
            font-size: var(--type-heading-lg-size);
            font-weight: var(--type-heading-lg-weight);
            font-family: var(--font-family-numeric);
            color: var(--color-content-primary-text);
            line-height: var(--line-height-4);
            letter-spacing: var(--letter-spacing-2);
        }

        .est-summary-value-appendage {
            font-size: var(--font-size-2);
            color: var(--color-content-secondary-text);
            font-weight: var(--font-weight-400);
            margin-left: var(--space-2);
        }

        .confidence-badge {
            display: inline-block;
            padding: var(--space-1) var(--space-3);
            background: var(--color-yellow-500);
            color: var(--color-neutral-0);
            border-radius: 999px;
            font-size: var(--font-size-1);
            font-size: var(--font-size-2);
            font-weight: var(--font-weight-600);
        }

        .section-description {
            font-size: var(--font-size-2);
            color: var(--color-content-secondary-text);
            line-height: var(--line-height-3);
            margin-top: 0;
            margin-bottom: var(--space-4);
        }
        
        /* Ensure consistent spacing between header and description in Estimation Summary */
        .est-summary-section-title + .section-description {
            margin-top: 0;
        }
        
        .market-rent-graph-card .est-summary-section-title {
            margin-bottom: var(--space-2);
        }
        
        .market-rent-graph-card .section-description {
            margin-bottom: 0;
            margin-top: 0;
            line-height: 1.2;
            padding-bottom: 0;
        }

        /* Est. Starting Rent Today Section (for Transaction Details) */
        .est-starting-rent-section {
            margin-bottom: var(--space-1);
        }

        .market-rent-chart-container {
            width: 100%;
            min-height: 460px;
            padding: var(--space-6);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .market-rent-graph-card .market-rent-chart-container {
            min-height: 680px;
            padding: 0 var(--space-6) var(--space-6) var(--space-6);
            margin-top: calc(var(--space-4) * -1);
        }

        .market-rent-line-chart {
            width: 100%;
            height: auto;
            min-height: 460px;
        }
        
        .market-rent-graph-card .market-rent-line-chart {
            height: 600px;
            min-height: 600px;
        }
        
        .market-rent-line-chart .chart-grid {
            stroke: var(--color-content-tertiary-border);
            stroke-width: 0.5;
            stroke-dasharray: 4 2;
        }

        .market-rent-line-chart .chart-axis-label {
            font-family: var(--font-family-text);
            font-size: 11px;
            fill: var(--color-content-secondary-text);
        }

        .market-rent-line-chart .chart-axis-label-numeric {
            font-family: var(--font-family-numeric);
        }

        .market-rent-line-chart .chart-line {
            fill: none;
            stroke: var(--color-blue-500);
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .market-rent-line-chart .chart-line-projected {
            stroke-dasharray: 4, 4;
            opacity: 0.7;
        }

        .market-rent-line-chart .chart-area {
            fill: url(#rent-line-gradient);
            stroke: none;
        }

        .market-rent-line-chart .chart-dot {
            fill: var(--color-blue-500);
            cursor: pointer;
            pointer-events: all;
            transition: r 0.2s;
        }
        
        .market-rent-line-chart .chart-dot:hover {
            r: 7;
        }
        
        .market-rent-line-chart .chart-dot-projected {
            opacity: 0.7;
        }
        
        .market-rent-line-chart .chart-dot-projected:hover {
            opacity: 1;
        }

        .market-rent-line-chart .chart-gradient-stop {
            stop-color: var(--color-blue-500);
        }
        
        /* Chart Tooltip */
        .chart-tooltip {
            position: absolute;
            background: var(--color-neutral-800);
            color: var(--color-neutral-0);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-1);
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .chart-tooltip.visible {
            opacity: 1;
        }
        
        .chart-tooltip-line {
            display: block;
            margin-top: var(--space-1);
        }
        
        .chart-tooltip-value {
            font-weight: var(--font-weight-600);
            font-family: var(--font-family-numeric);
        }
        
        .chart-tooltip-percentage {
            color: var(--color-green-500);
        }
        
        .calculation-breakdown {
            margin-top: var(--space-4);
        }

        .calculation-breakdown-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid var(--color-content-secondary-border);
            border-radius: var(--radius-sm);
            overflow: hidden;
            background: var(--color-neutral-0);
        }

        .calculation-breakdown-table th {
            text-align: left;
            font-size: var(--font-size-2);
            font-weight: var(--font-weight-600);
            color: var(--color-content-primary-text);
            padding: var(--space-3) var(--space-4);
            background: var(--color-neutral-0);
            border-bottom: 1px solid var(--color-content-tertiary-border);
        }
        
        .calculation-breakdown-table th:first-child {
            border-top-left-radius: var(--radius-sm);
        }
        
        .calculation-breakdown-table th:last-child {
            border-top-right-radius: var(--radius-sm);
        }

        .calculation-breakdown-table th:last-child {
            text-align: right;
        }

        .calculation-breakdown-table td {
            padding: var(--space-3) var(--space-4);
            font-size: var(--font-size-2);
            border-bottom: 1px solid var(--color-content-tertiary-border);
            background: var(--color-neutral-0);
        }
        
        .calculation-breakdown-table td.calculation-final-value {
            font-size: var(--type-heading-lg-size) !important;
        }

        .calculation-breakdown-table td:last-child {
            text-align: right;
            font-family: var(--font-family-numeric);
            color: var(--color-content-primary-text);
        }

        .calculation-row-label {
            color: var(--color-content-primary-text);
        }

        .calculation-breakdown-table td:last-child:not(.calculation-final-value) {
            font-weight: var(--font-weight-600);
        }

        .calculation-final-row {
            background: rgba(139, 92, 246, 0.05);
        }

        .calculation-final-row td {
            border-bottom: none;
            padding-top: var(--space-4);
            padding-bottom: var(--space-4);
            background: rgba(139, 92, 246, 0.05);
        }
        
        .calculation-final-row td:first-child {
            border-bottom-left-radius: var(--radius-sm);
        }
        
        .calculation-final-row td:last-child {
            border-bottom-right-radius: var(--radius-sm);
        }

        .calculation-final-cell {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .calculation-final-label {
            font-size: var(--font-size-2);
            font-weight: var(--font-weight-600);
            color: var(--color-violet-400);
        }

        .calculation-final-formula {
            font-size: var(--font-size-1);
            color: var(--color-content-secondary-text);
            font-weight: var(--font-weight-400);
        }

        .calculation-final-value {
            font-size: var(--type-heading-lg-size) !important;
            font-weight: var(--type-heading-lg-weight);
            font-family: var(--font-family-numeric);
            color: var(--color-violet-400);
            flex-shrink: 0;
        }
        
        /* Chart Container */
        .chart-container {
            width: 100%;
            height: 300px;
            background: var(--color-surface-canvas);
            border: 1px solid var(--color-content-secondary-border);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-content-tertiary-text);
        }
        
        .chart-placeholder {
            text-align: center;
        }
        
        .chart-placeholder::before {
            content: '';
            display: block;
            width: 200px;
            height: 150px;
            margin: 0 auto var(--space-4);
            background: var(--color-content-tertiary-border);
            border-radius: var(--radius-md);
            opacity: 0.3;
        }
        
        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table thead {
            background: var(--color-surface-raised);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table th {
            padding: var(--space-3) var(--space-4);
            text-align: left;
            font-size: var(--font-size-2);
            font-weight: var(--font-weight-600);
            color: var(--color-content-primary-text);
            border-bottom: 1px solid var(--color-content-secondary-border);
            white-space: nowrap;
        }
        
        .data-table td {
            padding: var(--space-3) var(--space-4);
            font-size: var(--font-size-3);
            color: var(--color-content-primary-text);
            border-bottom: 1px solid var(--color-content-tertiary-border);
        }
        
        .data-table tbody tr:hover {
            background: var(--color-surface-interactive-hover);
        }
        
        .data-table .numeric {
            font-family: var(--font-family-numeric);
            text-align: right;
        }
        
        .data-table .change-positive {
            color: var(--color-green-500);
        }
        
        .data-table .change-negative {
            color: var(--color-red-500);
        }
        
        /* Responsive Design */
        @media (max-width: 1023px) {
            /* Hide sidebar on mobile/tablet */
            .side-nav {
                display: none;
            }
            
            /* Make right content take full width */
            .right-content {
                width: 100%;
            }
            
            /* Stack Estimation Summary columns vertically */
            .estimated-summary-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="top-nav">
        <div class="top-nav-left">
            <div class="logo">CS</div>
            <div class="nav-links">
                <a href="#" class="nav-link">LEASES</a>
                <a href="#" class="nav-link">SALES</a>
                <a href="#" class="nav-link">PROPERTIES</a>
                <span class="nav-separator">|</span>
                <a href="#" class="nav-link">CHARTBUILDER</a>
                <a href="#" class="nav-link">MARKET DASHBOARD</a>
                <a href="#" class="nav-link">PORTFOLIOS</a>
                <a href="#" class="nav-link">COMPSCOUT*</a>
                <span class="nav-separator">|</span>
                <a href="#" class="nav-link">SAVED SEARCHES</a>
                <a href="#" class="nav-link">SUPPORT</a>
            </div>
        </div>
        <div class="top-nav-right">
            <button class="invite-button">Invite</button>
            <div class="avatar">JW</div>
        </div>
    </nav>
    
    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Left Side Navigation -->
        <aside class="side-nav">
            <div class="side-nav-header">
                <div class="side-nav-location-label">NEW YORK CITY (CHELSEA)</div>
                <div class="side-nav-property-address">675 Avenue of the Americas</div>
                <div class="side-nav-address-details">
                    New York, NY 10011<br>
                    APN: 00797-0037
                </div>
                <div class="side-nav-attributes">
                    <div class="side-nav-attribute-item">
                        <span class="side-nav-attribute-label">Property Type:</span>
                        <span class="side-nav-attribute-value">Office</span>
                    </div>
                    <div class="side-nav-attribute-item">
                        <span class="side-nav-attribute-label">Property Subtype:</span>
                        <span class="side-nav-attribute-value">Mixed-Use</span>
                    </div>
                    <div class="side-nav-attribute-item">
                        <span class="side-nav-attribute-label">Building Size:</span>
                        <span class="side-nav-attribute-value">311,000 SqFt</span>
                    </div>
                    <div class="side-nav-attribute-item">
                        <span class="side-nav-attribute-label">Class:</span>
                        <span class="side-nav-attribute-value">A</span>
                    </div>
                    <div class="side-nav-attribute-item">
                        <span class="side-nav-attribute-label">Year Built / Renovated:</span>
                        <span class="side-nav-attribute-value">1901 / 2013</span>
                    </div>
                </div>
            </div>
            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='320' height='200'%3E%3Crect width='320' height='200' fill='%23EBECF0'/%3E%3Crect x='20' y='20' width='60' height='160' fill='%23C1C7D0'/%3E%3Crect x='100' y='40' width='60' height='140' fill='%23C1C7D0'/%3E%3Crect x='180' y='30' width='60' height='150' fill='%23C1C7D0'/%3E%3Crect x='240' y='50' width='20' height='130' fill='%23C1C7D0'/%3E%3C/svg%3E" alt="Property" class="property-image">
            <div class="property-details">
                <div class="property-detail-row">
                    <div class="property-detail-label">Bldg Size</div>
                    <div class="property-detail-value">125,000 sq ft</div>
                </div>
                <div class="property-detail-row">
                    <div class="property-detail-label">Floor Count</div>
                    <div class="property-detail-value">12</div>
                </div>
                <div class="property-detail-row">
                    <div class="property-detail-label">Price/SF</div>
                    <div class="property-detail-value">$485</div>
                </div>
                <div class="property-detail-row">
                    <div class="property-detail-label">Units</div>
                    <div class="property-detail-value">45</div>
                </div>
            </div>
            <!-- Sticky Est. Starting Rent Today Card -->
            <div class="sticky-est-rent-card" id="sticky-est-rent-card">
                <div class="sticky-est-rent-header">
                    <div class="sticky-est-rent-title-wrapper">
                        <div class="sticky-est-rent-title">
                            Est. Starting Rent Today
                            <span style="opacity: 0.7;">✨</span>
                        </div>
                        <div class="sticky-est-rent-info-icon">?</div>
                    </div>
                    <div class="sticky-est-rent-action-icon" title="Calculator">
                        <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="2" y="2" width="12" height="12" rx="1" stroke="currentColor" stroke-width="1" fill="none"/>
                            <line x1="4" y1="5" x2="6" y2="5" stroke="currentColor" stroke-width="1"/>
                            <line x1="4" y1="6.5" x2="6" y2="6.5" stroke="currentColor" stroke-width="0.8"/>
                            <line x1="4" y1="8" x2="6" y2="8" stroke="currentColor" stroke-width="0.8"/>
                            <line x1="4" y1="9.5" x2="6" y2="9.5" stroke="currentColor" stroke-width="0.8"/>
                            <line x1="9" y1="5" x2="11" y2="5" stroke="currentColor" stroke-width="1"/>
                            <line x1="10" y1="4" x2="10" y2="6" stroke="currentColor" stroke-width="1"/>
                            <line x1="9" y1="7.5" x2="11" y2="7.5" stroke="currentColor" stroke-width="1"/>
                            <line x1="9" y1="9" x2="11" y2="9" stroke="currentColor" stroke-width="1"/>
                        </svg>
                    </div>
                </div>
                <div class="sticky-est-rent-main-value">
                    <span class="sticky-est-rent-value">$60.50</span>
                    <span class="sticky-est-rent-annotation">(Ann.)</span>
                    <span class="sticky-est-rent-separator">|</span>
                    <span class="sticky-est-rent-percentage">+10.5%</span>
                </div>
                <div class="sticky-est-rent-comparison">
                    vs. Current Rent: <span class="comparison-value">$55.17 (Ann.)</span>
                </div>
                <div class="sticky-est-rent-detail-row">
                    <span class="sticky-est-rent-detail-label">Comparable Leases</span>
                    <span class="sticky-est-rent-detail-value">50</span>
                </div>
                <div class="sticky-est-rent-detail-row">
                    <span class="sticky-est-rent-detail-label">Execution Date</span>
                    <span class="sticky-est-rent-detail-value">Sep 9, 2022</span>
                </div>
                <div class="sticky-est-rent-detail-row">
                    <span class="sticky-est-rent-detail-label">Term</span>
                    <span class="sticky-est-rent-detail-value">5y</span>
                </div>
                <button class="sticky-est-rent-button">
                    See Transaction Details →
                </button>
            </div>
        </aside>
        
        <!-- Right Content Area -->
        <main class="right-content">
            <!-- Hero Section -->
            <div class="hero-section">
                <div class="hero-content">
                    <div class="transaction-summary">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%; margin-bottom: var(--space-4);">
                            <div class="verification-badge">
                                <div class="verification-circle">7</div>
                                <span>CompStak users have verified this lease data</span>
                            </div>
                            <button class="suggest-update-button">Suggest an Update</button>
                        </div>
                        <div style="width: 100%; margin-bottom: var(--space-4);">
                            <div class="transaction-title">
                                <div>
                                    <a href="#" class="compstak-link">CompStak</a><span class="transaction-title-text"> | Sep 9, 2022</span>
                                </div>
                                <div class="action-buttons">
                                    <button class="action-button">
                                        <span>📁</span>
                                        <span>Add to Portfolio</span>
                                    </button>
                                    <button class="action-button">
                                        <span>📄</span>
                                        <span>Property Report</span>
                                    </button>
                                    <button class="action-button primary">
                                        <span>⬇</span>
                                        <span>Export</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div style="width: 100%;">
                            <div class="transaction-details-grid">
                                <div class="transaction-detail-item">
                                    <span class="transaction-detail-label">Transaction SqFt</span>
                                    <span class="transaction-detail-value">25,644 SqFt</span>
                                </div>
                                <div class="transaction-detail-item">
                                    <span class="transaction-detail-label">Space Type</span>
                                    <span class="transaction-detail-value">Office</span>
                                </div>
                                <div class="transaction-detail-item">
                                    <span class="transaction-detail-label">Lease Term</span>
                                    <span class="transaction-detail-value">5y</span>
                                </div>
                                <div class="transaction-detail-item">
                                    <span class="transaction-detail-label">Commencement Date</span>
                                    <span class="transaction-detail-value">Oct 28, 2022</span>
                                </div>
                                <div class="transaction-detail-item">
                                    <span class="transaction-detail-label">Starting Rent</span>
                                    <span class="transaction-detail-value">$55.00<span class="transaction-detail-appendage"> (Ann.)</span></span>
                                </div>
                                <div class="transaction-detail-item">
                                    <span class="transaction-detail-label">Current Rent</span>
                                    <span class="transaction-detail-value">$55.17<span class="transaction-detail-appendage"> (Ann.)</span></span>
                                </div>
                                <div class="est-rent-detail-item">
                                    <span class="est-rent-detail-label" style="white-space: nowrap;">
                                        Est. Starting Rent Today
                                        <span style="opacity: 0.7;">✨</span>
                                        <span class="info-icon" style="margin-left: var(--space-1);">i</span>
                                    </span>
                                    <span class="est-rent-detail-value">
                                        $60.50 <span class="est-rent-detail-appendage">(Ann.) | <span class="green-value">+10.5%</span></span>
                                    </span>
                                    <span class="est-rent-calculated-note">
                                        <span>📊</span>
                                        <span>Calculated based on <a href="#" class="comps-link" id="comps-link" onclick="event.preventDefault(); switchToTab('underlying-comps'); return false;">50 Comps</a></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" data-tab="transaction-details">Transaction Details</button>
                <button class="tab" data-tab="underlying-comps">Rent Calculation <span style="opacity: 0.7;">✨</span></button>
                <button class="tab" data-tab="estimated-summary">Estimation Summary <span style="opacity: 0.7;">✨</span></button>
            </div>
            
            <!-- Tab Content Wrapper -->
            <div class="tab-content-wrapper">
                <!-- Transaction Details Tab -->
                <div id="transaction-details" class="tab-content active">
                    <div class="content-layout">
                        <!-- Column 1: Lease -->
                        <div class="content-column">
                            <div class="section">
                                <h3 class="section-title">Lease</h3>
                                <div class="detail-row">
                                    <span class="detail-label">Tenant Name</span>
                                    <span class="detail-value"><a href="#">CompStak</a></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Transaction Quarter</span>
                                    <span class="detail-value">2022 - Q3</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Transaction SqFt</span>
                                    <span class="detail-value">25,644</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Transaction Type</span>
                                    <span class="detail-value">New Lease</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Lease History</span>
                                    <span class="detail-value">Relocation from <a href="#">36 Cooper Square</a></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Starting Rent (PSF)</span>
                                    <span class="detail-value">$55.00 (Ann.)</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Lease Type</span>
                                    <span class="detail-value">Modified Gross</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Free Rent</span>
                                    <span class="detail-value">2m</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Asking Rent (PSF)</span>
                                    <span class="detail-value">$78.00</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Rent Schedule</span>
                                    <span class="detail-value">2.50% per year</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Net Effective Rent (PSF)</span>
                                    <span class="detail-value">$55.17<span class="info-icon">i</span></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Work Type</span>
                                    <span class="detail-value">Built to Suit</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">TI Value / Work Value (PSF)</span>
                                    <span class="detail-value">$12.00</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Subleases</span>
                                    <span class="detail-value">No</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Current Rent (PSF)</span>
                                    <span class="detail-value">$55.00<span class="info-icon">i</span></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Concession Notes</span>
                                    <span class="detail-value" style="text-align: left; font-size: var(--font-size-2); line-height: var(--line-height-3);">TI does not include soft costs, also covered by landlord. Space comes fully furnished with desks. Additional work is for additional conference rooms, private bathrooms, and pantry renovation.</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Operating Expense (PSF)</span>
                                    <span class="detail-value">$50.92</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Operating Expense Notes</span>
                                    <span class="detail-value" style="text-align: left;">Tax and operating expenses ($)</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Column 2: Space, Date, Notes -->
                        <div class="content-column">
                            <!-- Space Section -->
                            <div class="section">
                                <h3 class="section-title">Space</h3>
                                <div class="detail-row">
                                    <span class="detail-label">Space Type</span>
                                    <span class="detail-value">Office</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Space Subtype</span>
                                    <span class="detail-value">-</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Floor(s) Occupied</span>
                                    <span class="detail-value">Partial 4</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Suite</span>
                                    <span class="detail-value">-</span>
                                </div>
                            </div>
                            
                            <!-- Date Section -->
                            <div class="section">
                                <h3 class="section-title">Date</h3>
                                <div class="detail-row">
                                    <span class="detail-label">Execution Date</span>
                                    <span class="detail-value">Sep 9, 2022</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Commencement Date</span>
                                    <span class="detail-value">Oct 28, 2022</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Expiration Date</span>
                                    <span class="detail-value">Oct 27, 2027</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Lease Term</span>
                                    <span class="detail-value">5y</span>
                                </div>
                            </div>
                            
                            <!-- Notes Section -->
                            <div class="section">
                                <h3 class="section-title">Notes</h3>
                                <div class="notes-text">
                                    Space formerly occupied by Quartz. Relocation from <a href="#">36 Cooper Square</a>.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Column 3: Landlord, Tenant, Tenant Brokerage -->
                        <div class="content-column">
                            <!-- Landlord Section -->
                            <div class="section">
                                <h3 class="section-title">Landlord</h3>
                                <div class="detail-row">
                                    <span class="detail-label">Current Landlord</span>
                                    <span class="detail-value"><a href="#">GFP Real Estate</a>, Guidepoint</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Landlord Brokerage Firms</span>
                                    <span class="detail-value"><a href="#">Newmark</a></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Landlord Brokers</span>
                                    <span class="detail-value">Anthony Sciacca, Robert Silver</span>
                                </div>
                            </div>
                            
                            <!-- Tenant Section -->
                            <div class="section">
                                <h3 class="section-title">Tenant</h3>
                                <div class="detail-row">
                                    <span class="detail-label">HQ Address</span>
                                    <span class="detail-value" style="text-align: left;">36 Cooper Sq 6th Floor New York, NY 10003, United States</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Employees*</span>
                                    <span class="detail-value">38</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Phone Number*</span>
                                    <span class="detail-value">+1 646 926 6707</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Website*</span>
                                    <span class="detail-value"><a href="#">www.compstak.com</a></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Status*</span>
                                    <span class="detail-value">Operating</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Ownership*</span>
                                    <span class="detail-value">Private</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Industry*</span>
                                    <span class="detail-value"><a href="#">Software & Information</a></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Primary NAICS / SIC (US)*</span>
                                    <span class="detail-value"><a href="#">519130 / 7375</a></span>
                                </div>
                                <div class="data-provider-note">*DATA PROVIDED BY DEMANDBASE</div>
                            </div>
                            
                            <!-- Tenant Brokerage Section -->
                            <div class="section">
                                <h3 class="section-title">Tenant Brokerage</h3>
                                <div class="detail-row">
                                    <span class="detail-label">Tenant Brokerage Firms</span>
                                    <span class="detail-value"><a href="#">Newmark</a></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Tenant Brokers</span>
                                    <span class="detail-value">Todd Hershman, Josh Gosin</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Underlying Comps Tab -->
                <div id="underlying-comps" class="tab-content">
                    <div class="underlying-comps-header">
                        <h2 class="underlying-comps-title">Rent Calculation <span style="opacity: 0.7;">✨</span></h2>
                        <p class="underlying-comps-subtitle">See how 50 comparable leases are adjusted and weighted to produce Est. Starting Rent Today.</p>
                    </div>
                    
                    <div class="map-container" id="comps-map-container">
                        <button class="map-fullscreen-button" id="map-fullscreen-btn" title="Enter fullscreen">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button class="map-reset-view-button" id="map-reset-view-btn" title="Reset view to show all pins">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M9 12h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 9l3 3-3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Reset View</span>
                        </button>
                        <div id="comps-map" style="width:100%;height:100%;"></div>
                        <div class="map-callout" id="map-callout">
                            <div class="map-callout-header">
                                <div class="map-callout-address-section">
                                    <div class="map-callout-pin-indicator" id="callout-pin-indicator"></div>
                                    <div class="map-callout-address-wrapper">
                                        <div class="map-callout-address" id="callout-address"></div>
                                        <div class="map-callout-location" id="callout-location"></div>
                                    </div>
                                </div>
                                <button class="map-callout-close" id="callout-close">×</button>
                            </div>
                            <div class="map-callout-content">
                                <div class="map-callout-type-info" id="callout-type-info"></div>
                                <div class="map-callout-metrics" id="callout-metrics"></div>
                                <div class="map-callout-actions">
                                    <button class="map-callout-button primary" id="view-comparable-leases-btn">
                                        <span>📄</span>
                                        <span>View Comparable Leases</span>
                                        <span>→</span>
                                    </button>
                                    <button class="map-callout-button secondary">
                                        <span>📁+</span>
                                        <span>Add Property to Portfolio</span>
                                        <span>→</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Modal Dialog -->
                        <div class="modal-overlay" id="leases-modal">
                            <div class="modal-dialog">
                                <div class="modal-header">
                                    <h3 class="modal-title">View Comparable Leases</h3>
                                    <button class="modal-close" id="modal-close">×</button>
                                </div>
                                <div class="modal-body">
                                    When clicked, the user is taken to the Leases page showing the specific underlying lease comps associated from the table below.
                                </div>
                            </div>
                        </div>
                        <div class="comps-map-legend">
                            <div class="comps-map-legend-title">Map Legend</div>
                            <div class="comps-map-legend-item">
                                <svg class="comps-map-pin" viewBox="0 0 24 36" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 0C5.37 0 0 5.37 0 12c0 9 12 24 12 24s12-15 12-24C24 5.37 18.63 0 12 0z" fill="#E91E8C"/><circle cx="12" cy="12" r="5" fill="white"/></svg>
                                <span>Subject Lease</span>
                            </div>
                            <div class="comps-map-legend-item">
                                <svg class="comps-map-pin" viewBox="0 0 24 36" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 0C5.37 0 0 5.37 0 12c0 9 12 24 12 24s12-15 12-24C24 5.37 18.63 0 12 0z" fill="#228FFF"/><circle cx="12" cy="12" r="5" fill="white"/></svg>
                                <span>Comparable Leases</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="comps-table-wrapper">
                        <table class="comps-table" id="comps-table">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="address">Address<span class="sort-indicator"></span></th>
                                    <th class="sortable" data-sort="transQtr">Trans Qtr.<span class="sort-indicator"></span></th>
                                    <th class="sortable" data-sort="tenant">Tenant<span class="sort-indicator"></span></th>
                                    <th class="numeric sortable" data-sort="sqft">Transaction SqFt<span class="sort-indicator"></span></th>
                                    <th class="numeric sortable" data-sort="currentRent">Starting Rent<span class="sort-indicator"></span></th>
                                    <th class="numeric sortable" data-sort="adjustment">Adjustment ($)<span class="sort-indicator"></span></th>
                                    <th class="numeric sortable" data-sort="similarity">Similarity Score<span class="sort-indicator"></span></th>
                                    <th class="numeric sortable" data-sort="impact">Impact (%)<span class="sort-indicator"></span></th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="comps-table-body">
                                <!-- Rendered by JS -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="comps-pagination" id="comps-pagination">
                        <!-- Rendered by JS -->
                    </div>
                </div>
                
                <!-- Estimated Summary Tab -->
                <div id="estimated-summary" class="tab-content">
                    <div class="estimated-summary-layout">
                        <!-- Left Column: Calculation Breakdown -->
                        <div class="estimated-summary-left-column">
                            <!-- Calculation Breakdown -->
                            <div class="dashboard-card calculation-breakdown-card">
                                <h3 class="est-summary-section-title">Calculation Breakdown</h3>
                                <p class="section-description">
                                    A detailed breakdown of how we arrived at the estimated starting rent, showing each adjustment factor applied to the original lease terms.
                                </p>
                                <div class="calculation-breakdown">
                                    <table class="calculation-breakdown-table">
                                        <thead>
                                            <tr>
                                                <th>Adjustments</th>
                                                <th>Adjustment (PSF)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="calculation-row-label">Original Starting Rent</td>
                                                <td>$55.00</td>
                                            </tr>
                                            <tr>
                                                <td class="calculation-row-label">Market Rent at Lease Execution</td>
                                                <td>$54.75</td>
                                            </tr>
                                            <tr>
                                                <td class="calculation-row-label">Market Rent Today (Jan 2026)</td>
                                                <td>$60.50</td>
                                            </tr>
                                            <tr>
                                                <td class="calculation-row-label">Market Change over 3+ Years</td>
                                                <td style="color: var(--color-green-500);">+10.5%</td>
                                            </tr>
                                            <tr class="calculation-final-row">
                                                <td class="calculation-final-cell">
                                                    <div class="calculation-final-label">Estimated Starting Rent Today <span style="opacity: 0.7;">✨</span></div>
                                                    <div class="calculation-final-formula">($55.00 × 1.105)</div>
                                                </td>
                                                <td class="calculation-final-value">$60.50</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Market Starting Rent Trend Graph -->
                        <div class="estimated-summary-right-column">
                            <div class="dashboard-card market-rent-graph-card">
                                <h3 class="est-summary-section-title">Market Starting Rent Trend</h3>
                                <p class="section-description">
                                    Track how market starting rent has evolved since the original lease was signed. This trend reflects overall market movement in the Chicago for office spaces.
                                </p>
                                <div class="market-rent-chart-container">
                                    <svg class="market-rent-line-chart" viewBox="0 0 650 400" preserveAspectRatio="xMidYMid meet">
                                        <defs>
                                            <linearGradient id="rent-line-gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                                <stop offset="0%" class="chart-gradient-stop" stop-opacity="0.2"/>
                                                <stop offset="100%" class="chart-gradient-stop" stop-opacity="0"/>
                                            </linearGradient>
                                        </defs>
                                        <!-- Y-axis label -->
                                        <text class="chart-axis-label" x="10" y="200" font-size="12" text-anchor="middle" transform="rotate(-90 10 200)">Starting Rent PSF</text>
                                        <!-- Horizontal grid lines ($2.50 increments, $50-$65) - scaled for 400 height -->
                                        <line class="chart-grid" x1="60" y1="72" x2="600" y2="72"/>
                                        <line class="chart-grid" x1="60" y1="119" x2="600" y2="119"/>
                                        <line class="chart-grid" x1="60" y1="166" x2="600" y2="166"/>
                                        <line class="chart-grid" x1="60" y1="213" x2="600" y2="213"/>
                                        <line class="chart-grid" x1="60" y1="260" x2="600" y2="260"/>
                                        <line class="chart-grid" x1="60" y1="307" x2="600" y2="307"/>
                                        <line class="chart-grid" x1="60" y1="354" x2="600" y2="354"/>
                                        <!-- Y-axis labels ($2.50 increments, $50-$65) - scaled for 400 height -->
                                        <text class="chart-axis-label chart-axis-label-numeric" x="55" y="77" font-size="11" text-anchor="end">$65</text>
                                        <text class="chart-axis-label chart-axis-label-numeric" x="55" y="124" font-size="11" text-anchor="end">$62.50</text>
                                        <text class="chart-axis-label chart-axis-label-numeric" x="55" y="171" font-size="11" text-anchor="end">$60</text>
                                        <text class="chart-axis-label chart-axis-label-numeric" x="55" y="218" font-size="11" text-anchor="end">$57.50</text>
                                        <text class="chart-axis-label chart-axis-label-numeric" x="55" y="265" font-size="11" text-anchor="end">$55</text>
                                        <text class="chart-axis-label chart-axis-label-numeric" x="55" y="312" font-size="11" text-anchor="end">$52.50</text>
                                        <text class="chart-axis-label chart-axis-label-numeric" x="55" y="359" font-size="11" text-anchor="end">$50</text>
                                        <!-- X-axis labels -->
                                        <text class="chart-axis-label" x="120" y="380" font-size="11" text-anchor="middle">2020</text>
                                        <text class="chart-axis-label" x="180" y="380" font-size="11" text-anchor="middle">2021</text>
                                        <text class="chart-axis-label" x="240" y="380" font-size="11" text-anchor="middle">2022</text>
                                        <text class="chart-axis-label" x="300" y="380" font-size="11" text-anchor="middle">2023</text>
                                        <text class="chart-axis-label" x="360" y="380" font-size="11" text-anchor="middle">2024</text>
                                        <text class="chart-axis-label" x="420" y="380" font-size="11" text-anchor="middle">2025</text>
                                        <text class="chart-axis-label" x="480" y="380" font-size="11" text-anchor="middle">2026</text>
                                        <text class="chart-axis-label" x="540" y="380" font-size="11" text-anchor="middle">2027</text>
                                        <text class="chart-axis-label" x="600" y="380" font-size="11" text-anchor="middle">2028</text>
                                        <!-- X-axis label -->
                                        <text class="chart-axis-label" x="330" y="395" font-size="12" text-anchor="middle">Year</text>
                                        <!-- Data points: scaled for 400 height viewBox (multiply Y by 400/280 = 1.429) -->
                                        <!-- Historical data (2020-2026) -->
                                        <polyline class="chart-area" points="120,323 180,303 240,284 300,276 360,266 420,214 480,161 540,114 600,87 600,354 120,354"/>
                                        <!-- Solid line for historical data (2020-2026) -->
                                        <polyline class="chart-line" points="120,323 180,303 240,284 300,276 360,266 420,214 480,161"/>
                                        <!-- Dotted line for projected data (2027-2028) -->
                                        <polyline class="chart-line chart-line-projected" points="480,161 540,114 600,87"/>
                                        <!-- Historical data points -->
                                        <circle class="chart-dot" cx="120" cy="323" r="5" data-year="2020" data-rent="52.00" data-pct="-5.5"/>
                                        <circle class="chart-dot" cx="180" cy="303" r="5" data-year="2021" data-rent="53.00" data-pct="-3.6"/>
                                        <circle class="chart-dot" cx="240" cy="284" r="5" data-year="2022" data-rent="54.00" data-pct="-1.8"/>
                                        <circle class="chart-dot" cx="300" cy="276" r="5" data-year="2023" data-rent="54.50" data-pct="-0.9"/>
                                        <circle class="chart-dot" cx="360" cy="266" r="5" data-year="2024" data-rent="55.00" data-pct="0"/>
                                        <circle class="chart-dot" cx="420" cy="214" r="5" data-year="2025" data-rent="57.75" data-pct="5.0"/>
                                        <circle class="chart-dot" cx="480" cy="161" r="5" data-year="2026" data-rent="60.50" data-pct="10.0"/>
                                        <!-- Projected data points (future years) -->
                                        <circle class="chart-dot chart-dot-projected" cx="540" cy="114" r="5" data-year="2027" data-rent="63.00" data-pct="projected"/>
                                        <circle class="chart-dot chart-dot-projected" cx="600" cy="87" r="5" data-year="2028" data-rent="64.50" data-pct="projected"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // Function to switch to a specific tab
        function switchToTab(tabId) {
            // Remove active class from all tabs and tab contents
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to target tab and corresponding content
            const targetTab = document.querySelector(`[data-tab="${tabId}"]`);
            const targetContent = document.getElementById(tabId);
            
            if (targetTab && targetContent) {
                targetTab.classList.add('active');
                targetContent.classList.add('active');
                
                // Initialize chart tooltips when Estimation Summary tab is shown
                if (tabId === 'estimated-summary') {
                    setTimeout(() => initChartTooltips(), 100);
                }
                
                if (tabId === 'underlying-comps') {
                    requestAnimationFrame(() => {
                        initCompsMapIfNeeded();
                        if (typeof window.compsMap !== 'undefined') window.compsMap.invalidateSize();
                        initTableSorting();
                    });
                }
            }
        }
        
        // Tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.getAttribute('data-tab');
                switchToTab(targetTab);
            });
        });

        // Underlying Comps data: 50 leases across properties (property = highest level)
        const COMPs_PER_PAGE = 10;
        const compsProperties = [
            { address: '675 Avenue of the Americas', lat: 40.7419, lng: -73.9897, isSubject: true, pinLabel: null, city: 'New York', state: 'NY', zip: '10010', spaceType: 'OFFICE', buildingClass: 'CLASS A', propertySize: 311000, floors: 6, sqftExpiring12Mo: null, avgLeaseSize: 34500, lastSalePrice: '$89.0M', leases: [
                { transQtr: '2022-Q4', tenant: 'CompStak', isSubject: true, sqft: 25644, currentRent: '$55.17', estRent: '$60.50', rentSpread: '+10.50%', adjustment: '$5.33', similarity: 100 },
                { transQtr: '2024-Q1', tenant: 'TechCorp Solutions', isSubject: false, sqft: 28000, currentRent: '$56.00', estRent: '$58.50', rentSpread: '+4.46%', adjustment: '$2.50', similarity: 87 },
                { transQtr: '2024-Q2', tenant: 'Digital Innovations Inc', isSubject: false, sqft: 22000, currentRent: '$57.00', estRent: '$59.50', rentSpread: '+4.39%', adjustment: '$2.50', similarity: 82 },
                { transQtr: '2023-Q4', tenant: 'Finance Partners LLC', isSubject: false, sqft: 30000, currentRent: '$55.50', estRent: '$58.00', rentSpread: '+4.50%', adjustment: '$2.50', similarity: 89 }
            ]},
            { address: '580 6th Avenue', lat: 40.7430, lng: -73.9905, isSubject: false, pinLabel: 'A', city: 'New York', state: 'NY', zip: '10018', spaceType: 'OFFICE', buildingClass: 'CLASS B', propertySize: 285000, floors: 8, sqftExpiring12Mo: 12500, avgLeaseSize: 19800, lastSalePrice: '$42.5M', leases: [
                { transQtr: '2024-Q1', tenant: 'TechFlow Solutions', isSubject: false, sqft: 18250, currentRent: '$52.00', estRent: '$52.75', rentSpread: '+1.44%', adjustment: '$0.75', similarity: 76 },
                { transQtr: '2024-Q1', tenant: 'Digital Ventures Inc', isSubject: false, sqft: 21400, currentRent: '$51.50', estRent: '$53.50', rentSpread: '+3.88%', adjustment: '$2.00', similarity: 74 },
                { transQtr: '2024-Q2', tenant: 'CloudSync Technologies', isSubject: false, sqft: 19800, currentRent: '$52.25', estRent: '$54.25', rentSpread: '+3.83%', adjustment: '$2.00', similarity: 75 },
                { transQtr: '2024-Q2', tenant: 'Premium Office Solutions', isSubject: false, sqft: 16500, currentRent: '$48.00', estRent: '$56.00', rentSpread: '+16.67%', adjustment: '$8.00', similarity: 68 },
                { transQtr: '2023-Q4', tenant: 'Enterprise Realty Group', isSubject: false, sqft: 19500, currentRent: '$46.00', estRent: '$58.50', rentSpread: '+27.17%', adjustment: '$12.50', similarity: 62 }
            ]},
            { address: '100 Park Avenue', lat: 40.7430, lng: -73.9885, isSubject: false, pinLabel: 'B', city: 'New York', state: 'NY', zip: '10017', spaceType: 'OFFICE', buildingClass: 'CLASS A', propertySize: 450000, floors: 12, sqftExpiring12Mo: 18500, avgLeaseSize: 18975, lastSalePrice: '$125.0M', leases: [
                { transQtr: '2023-Q3', tenant: 'Meridian Capital Group', isSubject: false, sqft: 18750, currentRent: '$58.00', estRent: '$61.00', rentSpread: '+5.17%', adjustment: '$3.00', similarity: 79 },
                { transQtr: '2023-Q4', tenant: 'Summit Financial Advisors', isSubject: false, sqft: 19200, currentRent: '$57.50', estRent: '$60.50', rentSpread: '+5.22%', adjustment: '$3.00', similarity: 80 }
            ]},
            { address: '200 Broadway', lat: 40.7405, lng: -73.9910, isSubject: false, pinLabel: 'C', city: 'New York', state: 'NY', zip: '10007', spaceType: 'OFFICE', buildingClass: 'CLASS B', propertySize: 320000, floors: 10, sqftExpiring12Mo: 30000, avgLeaseSize: 30000, lastSalePrice: '$68.5M', leases: [
                { transQtr: '2024-Q2', tenant: 'LegalEdge Partners', isSubject: false, sqft: 32000, currentRent: '$48.00', estRent: '$51.00', rentSpread: '+6.25%', adjustment: '$3.00', similarity: 71 },
                { transQtr: '2024-Q2', tenant: 'Corporate Law Associates', isSubject: false, sqft: 28000, currentRent: '$49.00', estRent: '$52.00', rentSpread: '+6.12%', adjustment: '$3.00', similarity: 72 }
            ]},
            { address: '350 West 42nd Street', lat: 40.7420, lng: -73.9890, isSubject: false, pinLabel: 'D', city: 'New York', state: 'NY', zip: '10036', spaceType: 'OFFICE', buildingClass: 'CLASS B', propertySize: 420000, floors: 15, sqftExpiring12Mo: 35000, avgLeaseSize: 35000, lastSalePrice: '$95.0M', leases: [
                { transQtr: '2023-Q2', tenant: 'MediaWorks International', isSubject: false, sqft: 42000, currentRent: '$54.00', estRent: '$56.50', rentSpread: '+4.63%', adjustment: '$2.50', similarity: 73 },
                { transQtr: '2023-Q2', tenant: 'Creative Studios LLC', isSubject: false, sqft: 38000, currentRent: '$55.00', estRent: '$57.50', rentSpread: '+4.55%', adjustment: '$2.50', similarity: 74 },
                { transQtr: '2023-Q3', tenant: 'Brand Strategy Group', isSubject: false, sqft: 25000, currentRent: '$53.00', estRent: '$55.50', rentSpread: '+4.72%', adjustment: '$2.50', similarity: 75 }
            ]},
            { address: '460 West 34th Street', lat: 40.7425, lng: -73.9900, isSubject: false, pinLabel: 'E', city: 'New York', state: 'NY', zip: '10001', spaceType: 'OFFICE', buildingClass: 'CLASS B', propertySize: 380000, floors: 12, sqftExpiring12Mo: 28000, avgLeaseSize: 18633, lastSalePrice: '$72.0M', leases: [
                { transQtr: '2024-Q1', tenant: 'DataSync Analytics', isSubject: false, sqft: 15000, currentRent: '$56.00', estRent: '$58.50', rentSpread: '+4.46%', adjustment: '$2.50', similarity: 77 },
                { transQtr: '2024-Q1', tenant: 'Insight Metrics Corp', isSubject: false, sqft: 16800, currentRent: '$55.50', estRent: '$58.00', rentSpread: '+4.50%', adjustment: '$2.50', similarity: 78 },
                { transQtr: '2024-Q2', tenant: 'Business Intelligence Co', isSubject: false, sqft: 22000, currentRent: '$54.00', estRent: '$56.50', rentSpread: '+4.63%', adjustment: '$2.50', similarity: 76 },
                { transQtr: '2024-Q2', tenant: 'Analytics Pro Solutions', isSubject: false, sqft: 19500, currentRent: '$55.00', estRent: '$57.50', rentSpread: '+4.55%', adjustment: '$2.50', similarity: 77 },
                { transQtr: '2024-Q2', tenant: 'DataViz Technologies', isSubject: false, sqft: 20500, currentRent: '$55.50', estRent: '$58.00', rentSpread: '+4.50%', adjustment: '$2.50', similarity: 78 },
                { transQtr: '2024-Q3', tenant: 'Metrics & Insights LLC', isSubject: false, sqft: 18800, currentRent: '$54.50', estRent: '$57.00', rentSpread: '+4.59%', adjustment: '$2.50', similarity: 77 }
            ]},
            { address: '7 World Trade Center', lat: 40.7400, lng: -73.9880, isSubject: false, pinLabel: 'F', city: 'New York', state: 'NY', zip: '10007', spaceType: 'OFFICE', buildingClass: 'CLASS A', propertySize: 1700000, floors: 52, sqftExpiring12Mo: 50000, avgLeaseSize: 50000, lastSalePrice: '$385.0M', leases: [
                { transQtr: '2023-Q4', tenant: 'Global Finance Partners', isSubject: false, sqft: 52000, currentRent: '$62.00', estRent: '$65.00', rentSpread: '+4.84%', adjustment: '$3.00', similarity: 81 },
                { transQtr: '2024-Q1', tenant: 'Investment Advisory Group', isSubject: false, sqft: 48000, currentRent: '$61.50', estRent: '$64.50', rentSpread: '+4.88%', adjustment: '$3.00', similarity: 82 }
            ]},
            { address: '250 West 55th Street', lat: 40.7435, lng: -73.9895, isSubject: false, pinLabel: 'G', city: 'New York', state: 'NY', zip: '10019', spaceType: 'OFFICE', buildingClass: 'CLASS A', propertySize: 520000, floors: 20, sqftExpiring12Mo: 29000, avgLeaseSize: 29167, lastSalePrice: '$145.0M', leases: [
                { transQtr: '2023-Q1', tenant: 'Consulting Partners Inc', isSubject: false, sqft: 31000, currentRent: '$59.00', estRent: '$62.00', rentSpread: '+5.08%', adjustment: '$3.00', similarity: 83 },
                { transQtr: '2023-Q2', tenant: 'Strategic Advisors LLC', isSubject: false, sqft: 27500, currentRent: '$58.50', estRent: '$61.50', rentSpread: '+5.13%', adjustment: '$3.00', similarity: 84 },
                { transQtr: '2023-Q3', tenant: 'Management Consulting Group', isSubject: false, sqft: 29000, currentRent: '$59.50', estRent: '$62.50', rentSpread: '+5.04%', adjustment: '$3.00', similarity: 85 }
            ]},
            { address: '120 Broadway', lat: 40.7410, lng: -73.9905, isSubject: false, pinLabel: 'H', city: 'New York', state: 'NY', zip: '10005', spaceType: 'OFFICE', buildingClass: 'CLASS B', propertySize: 360000, floors: 11, sqftExpiring12Mo: 34000, avgLeaseSize: 32667, lastSalePrice: '$78.5M', leases: [
                { transQtr: '2024-Q1', tenant: 'Real Estate Ventures', isSubject: false, sqft: 36000, currentRent: '$50.00', estRent: '$52.50', rentSpread: '+5.00%', adjustment: '$2.50', similarity: 70 },
                { transQtr: '2024-Q2', tenant: 'Property Management Co', isSubject: false, sqft: 34000, currentRent: '$50.50', estRent: '$53.00', rentSpread: '+4.95%', adjustment: '$2.50', similarity: 71 },
                { transQtr: '2024-Q2', tenant: 'Commercial Realty Group', isSubject: false, sqft: 28000, currentRent: '$51.00', estRent: '$53.50', rentSpread: '+4.90%', adjustment: '$2.50', similarity: 72 }
            ]},
            { address: '1633 Broadway', lat: 40.7428, lng: -73.9888, isSubject: false, pinLabel: 'I', city: 'New York', state: 'NY', zip: '10019', spaceType: 'OFFICE', buildingClass: 'CLASS A', propertySize: 750000, floors: 25, sqftExpiring12Mo: 39400, avgLeaseSize: 39400, lastSalePrice: '$210.0M', leases: [
                { transQtr: '2022-Q4', tenant: 'Entertainment Media Corp', isSubject: false, sqft: 44000, currentRent: '$57.00', estRent: '$60.00', rentSpread: '+5.26%', adjustment: '$3.00', similarity: 86 },
                { transQtr: '2023-Q1', tenant: 'Broadcast Networks LLC', isSubject: false, sqft: 41000, currentRent: '$56.50', estRent: '$59.50', rentSpread: '+5.31%', adjustment: '$3.00', similarity: 85 },
                { transQtr: '2023-Q2', tenant: 'Digital Media Holdings', isSubject: false, sqft: 39000, currentRent: '$57.50', estRent: '$60.50', rentSpread: '+5.22%', adjustment: '$3.00', similarity: 86 },
                { transQtr: '2023-Q3', tenant: 'Content Production Studios', isSubject: false, sqft: 35000, currentRent: '$56.00', estRent: '$59.00', rentSpread: '+5.36%', adjustment: '$3.00', similarity: 85 },
                { transQtr: '2023-Q4', tenant: 'Streaming Services Inc', isSubject: false, sqft: 38000, currentRent: '$58.00', estRent: '$61.00', rentSpread: '+5.17%', adjustment: '$3.00', similarity: 86 }
            ]},
            { address: '11 Times Square', lat: 40.7432, lng: -73.9892, isSubject: false, pinLabel: 'J', city: 'New York', state: 'NY', zip: '10036', spaceType: 'OFFICE', buildingClass: 'CLASS A', propertySize: 680000, floors: 40, sqftExpiring12Mo: 24800, avgLeaseSize: 24633, lastSalePrice: '$195.0M', leases: [
                { transQtr: '2024-Q1', tenant: 'Advertising Agency Partners', isSubject: false, sqft: 27000, currentRent: '$60.00', estRent: '$63.00', rentSpread: '+5.00%', adjustment: '$3.00', similarity: 88 },
                { transQtr: '2024-Q2', tenant: 'Marketing Solutions Group', isSubject: false, sqft: 24500, currentRent: '$59.50', estRent: '$62.50', rentSpread: '+5.04%', adjustment: '$3.00', similarity: 87 },
                { transQtr: '2024-Q2', tenant: 'Brand Communications LLC', isSubject: false, sqft: 26000, currentRent: '$60.50', estRent: '$63.50', rentSpread: '+4.96%', adjustment: '$3.00', similarity: 88 },
                { transQtr: '2024-Q3', tenant: 'Creative Marketing Agency', isSubject: false, sqft: 22000, currentRent: '$58.00', estRent: '$61.00', rentSpread: '+5.17%', adjustment: '$3.00', similarity: 87 },
                { transQtr: '2024-Q3', tenant: 'Public Relations Firm', isSubject: false, sqft: 23500, currentRent: '$59.00', estRent: '$62.00', rentSpread: '+5.08%', adjustment: '$3.00', similarity: 88 },
                { transQtr: '2024-Q3', tenant: 'Digital Marketing Co', isSubject: false, sqft: 24800, currentRent: '$59.50', estRent: '$62.50', rentSpread: '+5.04%', adjustment: '$3.00', similarity: 87 }
            ]},
            { address: '1 Penn Plaza', lat: 40.7412, lng: -73.9902, isSubject: false, pinLabel: 'K', city: 'New York', state: 'NY', zip: '10119', spaceType: 'OFFICE', buildingClass: 'CLASS A', propertySize: 2400000, floors: 57, sqftExpiring12Mo: 332000, avgLeaseSize: 47214, lastSalePrice: '$550.0M', leases: [
                { transQtr: '2023-Q2', tenant: 'Healthcare Systems Inc', isSubject: false, sqft: 50000, currentRent: '$53.00', estRent: '$55.50', rentSpread: '+4.72%', adjustment: '$2.50', similarity: 69 },
                { transQtr: '2023-Q3', tenant: 'Medical Services Group', isSubject: false, sqft: 47000, currentRent: '$52.50', estRent: '$55.00', rentSpread: '+4.76%', adjustment: '$2.50', similarity: 70 },
                { transQtr: '2023-Q4', tenant: 'Pharmaceutical Research Co', isSubject: false, sqft: 51000, currentRent: '$53.50', estRent: '$56.00', rentSpread: '+4.67%', adjustment: '$2.50', similarity: 69 },
                { transQtr: '2024-Q1', tenant: 'Biotech Innovations LLC', isSubject: false, sqft: 49000, currentRent: '$54.00', estRent: '$56.50', rentSpread: '+4.63%', adjustment: '$2.50', similarity: 70 },
                { transQtr: '2024-Q1', tenant: 'HealthTech Solutions', isSubject: false, sqft: 45500, currentRent: '$53.50', estRent: '$56.00', rentSpread: '+4.67%', adjustment: '$2.50', similarity: 69 },
                { transQtr: '2024-Q1', tenant: 'Clinical Research Partners', isSubject: false, sqft: 46500, currentRent: '$53.75', estRent: '$56.25', rentSpread: '+4.65%', adjustment: '$2.50', similarity: 70 },
                { transQtr: '2024-Q2', tenant: 'Medical Device Corp', isSubject: false, sqft: 43000, currentRent: '$54.00', estRent: '$56.50', rentSpread: '+4.63%', adjustment: '$2.50', similarity: 70 }
            ]},
            { address: '55 Water Street', lat: 40.7408, lng: -73.9915, isSubject: false, pinLabel: 'L', city: 'New York', state: 'NY', zip: '10041', spaceType: 'OFFICE', buildingClass: 'CLASS B', propertySize: 330000, floors: 8, sqftExpiring12Mo: 31400, avgLeaseSize: 31400, lastSalePrice: '$62.0M', leases: [
                { transQtr: '2024-Q1', tenant: 'Insurance Services Group', isSubject: false, sqft: 33000, currentRent: '$47.00', estRent: '$49.50', rentSpread: '+5.32%', adjustment: '$2.50', similarity: 67 },
                { transQtr: '2024-Q2', tenant: 'Risk Management Advisors', isSubject: false, sqft: 29800, currentRent: '$47.50', estRent: '$50.00', rentSpread: '+5.26%', adjustment: '$2.50', similarity: 68 }
            ]},
            { address: '1325 Avenue of the Americas', lat: 40.7438, lng: -73.9882, isSubject: false, pinLabel: 'M', city: 'New York', state: 'NY', zip: '10019', spaceType: 'OFFICE', buildingClass: 'CLASS A', propertySize: 890000, floors: 18, sqftExpiring12Mo: 25500, avgLeaseSize: 24200, lastSalePrice: '$245.0M', leases: [
                { transQtr: '2023-Q1', tenant: 'Investment Banking Firm', isSubject: false, sqft: 24000, currentRent: '$64.00', estRent: '$67.00', rentSpread: '+4.69%', adjustment: '$3.00', similarity: 90 },
                { transQtr: '2023-Q2', tenant: 'Private Equity Partners', isSubject: false, sqft: 26500, currentRent: '$63.50', estRent: '$66.50', rentSpread: '+4.72%', adjustment: '$3.00', similarity: 91 },
                { transQtr: '2023-Q3', tenant: 'Wealth Management Group', isSubject: false, sqft: 23000, currentRent: '$64.50', estRent: '$67.50', rentSpread: '+4.65%', adjustment: '$3.00', similarity: 90 },
                { transQtr: '2023-Q4', tenant: 'Asset Management Co', isSubject: false, sqft: 25500, currentRent: '$63.75', estRent: '$66.75', rentSpread: '+4.71%', adjustment: '$3.00', similarity: 91 },
                { transQtr: '2024-Q1', tenant: 'Financial Advisory Services', isSubject: false, sqft: 22000, currentRent: '$64.50', estRent: '$67.50', rentSpread: '+4.65%', adjustment: '$3.00', similarity: 90 }
            ]}
        ];

        // Flatten to (propertyIndex, lease) for pagination
        // Calculate impact % based on adjustment size (less adjustments = higher impact)
        function calculateImpact(adjustmentStr) {
            const adjustment = Math.abs(parseFloat(adjustmentStr.replace('$', '')));
            // Inverse relationship: smaller adjustment = higher impact
            // Use a formula that gives higher impact to smaller adjustments
            // Impact ranges from ~1% to ~75% based on adjustment size (wider range)
            // Very small adjustments ($0-$1) get highest impact (~60-75%)
            // Small adjustments ($1-$2) get high impact (~45-60%)
            // Medium adjustments ($2-$5) get medium impact (~20-45%)
            // Larger adjustments ($5-$10) get lower impact (~5-20%)
            // Very large adjustments ($10+) get minimal but still valuable impact (~1-5%)
            // Formula ensures perfect inverse relationship: as adjustment increases, impact decreases
            if (adjustment <= 1) {
                return 60 + (1 - adjustment) * 15; // 60-75% for $0-$1 (smaller = higher)
            } else if (adjustment <= 2) {
                return 45 + (2 - adjustment) * 15; // 45-60% for $1-$2 (smaller = higher)
            } else if (adjustment <= 5) {
                return 20 + (5 - adjustment) * 8.33; // 20-45% for $2-$5 (smaller = higher)
            } else if (adjustment <= 10) {
                return 5 + (10 - adjustment) * 3; // 5-20% for $5-$10 (smaller = higher)
            } else {
                return Math.max(1, 5 - (adjustment - 10) * 0.4); // 1-5% for $10+ (smaller = higher, still valuable but minimal)
            }
        }
        
        // Normalize impact percentages so they sum to 100%
        // This preserves the inverse relationship: smaller adjustments = higher impact
        // After normalization, if adjustment A < adjustment B, then impact A > impact B
        function normalizeImpacts(comps) {
            const totalImpact = comps.reduce((sum, comp) => {
                const impact = calculateImpact(comp.lease.adjustment);
                return sum + impact;
            }, 0);
            
            return comps.map(comp => {
                const rawImpact = calculateImpact(comp.lease.adjustment);
                const normalizedImpact = (rawImpact / totalImpact) * 100;
                return { ...comp, impact: normalizedImpact };
            });
        }
        
        function flattenComps() {
            const flat = [];
            compsProperties.forEach((prop, i) => {
                prop.leases.forEach(lease => {
                    // Filter out subject leases (only include comparable leases)
                    if (!lease.isSubject) {
                        flat.push({ propIndex: i, lease });
                    }
                });
            });
            // Normalize impacts so they sum to 100%
            return normalizeImpacts(flat);
        }
        const compsFlat = flattenComps();
        const compsTotalPages = Math.ceil(compsFlat.length / COMPs_PER_PAGE);

        function pinSvg(color, label) {
            const L = label ? `<text x="12" y="18" text-anchor="middle" fill="white" font-size="14" font-weight="bold">${label}</text>` : '<circle cx="12" cy="12" r="5" fill="white"/>';
            return `<svg viewBox="0 0 24 36" width="28" height="36" xmlns="http://www.w3.org/2000/svg"><path d="M12 0C5.37 0 0 5.37 0 12c0 9 12 24 12 24s12-15 12-24C24 5.37 18.63 0 12 0z" fill="${color}"/>${L}</svg>`;
        }

        let compsMapInit = false;
        let compsMarkers = [];
        let selectedMarker = null;
        let compsSortColumn = null;
        let compsSortDirection = 'asc';
        
        function initCompsMapIfNeeded() {
            if (compsMapInit || typeof L === 'undefined') return;
            compsMapInit = true;
            const map = L.map('comps-map', {
                zoomControl: false,
                attributionControl: false
            });
            
            // Add zoom controls on top-left
            L.control.zoom({
                position: 'topleft'
            }).addTo(map);
            
            // Flat design map tiles - CartoDB Positron (light, flat style)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            
            compsMarkers = [];
            const bounds = L.latLngBounds([]);
            
            compsProperties.forEach((p, i) => {
                const color = p.isSubject ? '#E91E8C' : '#228FFF';
                const icon = L.divIcon({
                    html: pinSvg(color, p.pinLabel),
                    className: 'comps-custom-marker',
                    iconSize: [28, 36],
                    iconAnchor: [14, 36]
                });
                const marker = L.marker([p.lat, p.lng], { icon }).addTo(map);
                marker.bindTooltip(p.address, { permanent: false, direction: 'top' });
                marker.property = p;
                marker.propertyIndex = i;
                marker.on('click', function(e) {
                    e.originalEvent?.stopPropagation();
                    showMapPopover(p, e.latlng, marker);
                });
                compsMarkers.push(marker);
                bounds.extend([p.lat, p.lng]);
            });
            
            // Fit map to show all markers with padding
            if (bounds.isValid()) {
                map.fitBounds(bounds, { padding: [50, 50], maxZoom: 16 });
            } else {
                // Fallback to center on subject property if no bounds
                map.setView([40.7419, -73.9897], 15);
            }
            
            window.compsMap = map;
            
            // Close callout when clicking close button
            document.getElementById('callout-close')?.addEventListener('click', () => {
                document.getElementById('map-callout')?.classList.remove('visible');
                deselectMarker();
            });
            
            // Close callout when clicking on map (but not on callout itself)
            map.on('click', (e) => {
                const callout = document.getElementById('map-callout');
                if (callout && !callout.contains(e.originalEvent?.target)) {
                    callout.classList.remove('visible');
                    deselectMarker();
                }
            });
            
            // Prevent callout clicks from closing it
            document.getElementById('map-callout')?.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // Fullscreen toggle
            const fullscreenBtn = document.getElementById('map-fullscreen-btn');
            const mapContainer = document.getElementById('comps-map-container');
            if (fullscreenBtn && mapContainer) {
                fullscreenBtn.addEventListener('click', () => {
                    if (mapContainer.classList.contains('fullscreen')) {
                        // Exit fullscreen
                        mapContainer.classList.remove('fullscreen');
                        fullscreenBtn.innerHTML = `
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        `;
                        fullscreenBtn.title = 'Enter fullscreen';
                    } else {
                        // Enter fullscreen
                        mapContainer.classList.add('fullscreen');
                        fullscreenBtn.innerHTML = `
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        `;
                        fullscreenBtn.title = 'Exit fullscreen';
                    }
                    // Invalidate map size to force resize
                    setTimeout(() => {
                        if (window.compsMap) {
                            window.compsMap.invalidateSize();
                        }
                    }, 100);
                });
            }
            
            // Reset view button
            const resetViewBtn = document.getElementById('map-reset-view-btn');
            if (resetViewBtn && map) {
                resetViewBtn.addEventListener('click', () => {
                    // Recalculate bounds from all markers
                    const resetBounds = L.latLngBounds([]);
                    compsMarkers.forEach(marker => {
                        resetBounds.extend(marker.getLatLng());
                    });
                    
                    if (resetBounds.isValid()) {
                        map.fitBounds(resetBounds, { padding: [50, 50], maxZoom: 16 });
                    }
                });
            }
        }
        
        function deselectMarker() {
            if (selectedMarker) {
                const prop = selectedMarker.property;
                const color = prop.isSubject ? '#E91E8C' : '#228FFF';
                const icon = L.divIcon({
                    html: pinSvg(color, prop.pinLabel),
                    className: 'comps-custom-marker',
                    iconSize: [28, 36],
                    iconAnchor: [14, 36]
                });
                selectedMarker.setIcon(icon);
                selectedMarker = null;
            }
        }
        
        function showMapPopover(property, latlng, marker) {
            const callout = document.getElementById('map-callout');
            if (!callout) return;
            
            // Deselect previous marker
            deselectMarker();
            
            // Select new marker (highlight with darker blue)
            selectedMarker = marker;
            const selectedColor = property.isSubject ? '#E91E8C' : '#1E71ED'; // Use blue-700 for selected state
            const selectedIcon = L.divIcon({
                html: pinSvg(selectedColor, property.pinLabel),
                className: 'comps-custom-marker',
                iconSize: [28, 36],
                iconAnchor: [14, 36]
            });
            marker.setIcon(selectedIcon);
            
            // Show pin indicator in callout
            const pinIndicator = document.getElementById('callout-pin-indicator');
            if (pinIndicator) {
                const pinColor = property.isSubject ? '#E91E8C' : '#228FFF';
                pinIndicator.innerHTML = pinSvg(pinColor, property.pinLabel);
            }
            
            // Populate callout data
            document.getElementById('callout-address').textContent = property.address;
            document.getElementById('callout-location').textContent = `${property.city}, ${property.state} ${property.zip}`;
            
            // Space type - class - size
            const typeInfo = document.getElementById('callout-type-info');
            typeInfo.innerHTML = `
                <span>${property.spaceType}</span>
                <span class="separator">•</span>
                <span>${property.buildingClass}</span>
                <span class="separator">•</span>
                <span class="size">${(property.propertySize / 1000).toFixed(0)}K</span>
            `;
            
            // Metrics in a row
            const metrics = document.getElementById('callout-metrics');
            const expiringText = property.sqftExpiring12Mo ? property.sqftExpiring12Mo.toLocaleString() : '—';
            metrics.innerHTML = `
                <div class="map-callout-metric">
                    <div class="map-callout-metric-label">FLOORS</div>
                    <div class="map-callout-metric-value">${property.floors}</div>
                </div>
                <div class="map-callout-metric">
                    <div class="map-callout-metric-label">SQ FT EXP IN 12 MO.</div>
                    <div class="map-callout-metric-value">${expiringText}</div>
                </div>
                <div class="map-callout-metric">
                    <div class="map-callout-metric-label">AVG. LEASE SIZE</div>
                    <div class="map-callout-metric-value">${(property.avgLeaseSize / 1000).toFixed(1)}K</div>
                </div>
                <div class="map-callout-metric">
                    <div class="map-callout-metric-label">LAST SALE PRICE</div>
                    <div class="map-callout-metric-value">${property.lastSalePrice}</div>
                </div>
            `;
            
            // Show callout (positioned at bottom via CSS)
            callout.classList.add('visible');
        }

        function generateAdjustmentBreakdown(lease) {
            // Subject lease data (from the main transaction)
            const subjectData = {
                executionDate: '2022 - Q4',
                currentRent: '$55.17',
                buildingFloors: 6,
                propertySize: 311000,
                transactionSize: 25644,
                buildingYear: 1901,
                buildingClass: 'A',
                sublease: 'No',
                transactionType: 'New Lease'
            };
            
            // Generate comparable lease data based on the lease being compared
            const currentRentNum = parseFloat(lease.currentRent.replace('$', ''));
            const comparableData = {
                executionDate: lease.transQtr,
                currentRent: lease.currentRent,
                buildingFloors: Math.floor(Math.random() * 5) + 6, // 6-10 floors
                propertySize: Math.floor(Math.random() * 50000) + 250000, // 250k-300k
                transactionSize: lease.sqft,
                buildingYear: Math.floor(Math.random() * 50) + 1900, // 1900-1950
                buildingClass: ['A', 'B', 'A'][Math.floor(Math.random() * 3)],
                sublease: ['No', 'Yes', 'No'][Math.floor(Math.random() * 3)],
                transactionType: ['New Lease', 'Renewal', 'New Lease'][Math.floor(Math.random() * 3)]
            };
            
            // Calculate adjustments for each attribute
            const adjustments = {
                executionDate: calculateTimeAdjustment(subjectData.executionDate, comparableData.executionDate),
                currentRent: calculateRentAdjustment(parseFloat(subjectData.currentRent.replace('$', '')), currentRentNum),
                buildingFloors: comparableData.buildingFloors === subjectData.buildingFloors ? '—' : (comparableData.buildingFloors > subjectData.buildingFloors ? '+$0.50' : '-$0.50'),
                propertySize: Math.abs(comparableData.propertySize - subjectData.propertySize) < 20000 ? '—' : (comparableData.propertySize > subjectData.propertySize ? '+$0.25' : '-$0.25'),
                transactionSize: calculateSizeAdjustment(comparableData.transactionSize, subjectData.transactionSize),
                buildingYear: comparableData.buildingYear === subjectData.buildingYear ? '—' : (comparableData.buildingYear > subjectData.buildingYear ? '+$1.00' : '-$1.00'),
                buildingClass: comparableData.buildingClass === subjectData.buildingClass ? '—' : (comparableData.buildingClass === 'A' ? '+$0.50' : '-$0.50'),
                sublease: comparableData.sublease === subjectData.sublease ? '—' : (comparableData.sublease === 'Yes' ? '-$0.50' : '+$0.50'),
                transactionType: comparableData.transactionType === subjectData.transactionType ? '—' : (comparableData.transactionType === 'Renewal' ? '+$1.00' : '-$1.00')
            };
            
            // Use the adjustment value from the lease data (this is the source of truth)
            const leaseAdjustmentNum = parseFloat(lease.adjustment.replace('$', ''));
            const totalAdjustmentStr = leaseAdjustmentNum >= 0 ? `+$${leaseAdjustmentNum.toFixed(2)}` : `-$${Math.abs(leaseAdjustmentNum).toFixed(2)}`;
            
            // Scale individual adjustments proportionally to match the total
            let calculatedTotal = 0;
            Object.values(adjustments).forEach(adj => {
                if (adj !== '—') {
                    const adjValue = parseFloat(adj.replace('$', '').replace('+', ''));
                    if (adj.startsWith('-')) {
                        calculatedTotal -= adjValue;
                    } else {
                        calculatedTotal += adjValue;
                    }
                }
            });
            
            // If calculated total doesn't match, scale all adjustments proportionally
            if (Math.abs(calculatedTotal - leaseAdjustmentNum) > 0.01 && calculatedTotal !== 0) {
                const scaleFactor = leaseAdjustmentNum / calculatedTotal;
                Object.keys(adjustments).forEach(key => {
                    if (adjustments[key] !== '—') {
                        const adjValue = parseFloat(adjustments[key].replace('$', '').replace('+', ''));
                        const isNegative = adjustments[key].startsWith('-');
                        const scaledValue = Math.abs(adjValue * scaleFactor);
                        adjustments[key] = isNegative ? `-$${scaledValue.toFixed(2)}` : `+$${scaledValue.toFixed(2)}`;
                    }
                });
            }
            
            return `
                <div class="adjustment-breakdown-wrapper">
                    <div class="adjustment-breakdown-title">Itemized Adjustments</div>
                    <table class="adjustment-breakdown-table">
                        <thead>
                            <tr>
                                <th>Attribute</th>
                                <th>Comparable Lease</th>
                                <th>Subject</th>
                                <th>Adjustment (PSF)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="adjustment-label">Execution Date</td>
                                <td>${comparableData.executionDate}</td>
                                <td>${subjectData.executionDate}</td>
                                <td class="adjustment-value">${adjustments.executionDate}</td>
                            </tr>
                            <tr>
                                <td class="adjustment-label">Current Rent</td>
                                <td>${comparableData.currentRent}</td>
                                <td>${subjectData.currentRent}</td>
                                <td class="adjustment-value">${adjustments.currentRent}</td>
                            </tr>
                            <tr>
                                <td class="adjustment-label">Building Floors</td>
                                <td>${comparableData.buildingFloors}</td>
                                <td>${subjectData.buildingFloors}</td>
                                <td class="adjustment-value">${adjustments.buildingFloors}</td>
                            </tr>
                            <tr>
                                <td class="adjustment-label">Property Size</td>
                                <td>${comparableData.propertySize.toLocaleString()} SqFt</td>
                                <td>${subjectData.propertySize.toLocaleString()} SqFt</td>
                                <td class="adjustment-value">${adjustments.propertySize}</td>
                            </tr>
                            <tr>
                                <td class="adjustment-label">Transaction Size</td>
                                <td>${comparableData.transactionSize.toLocaleString()} SqFt</td>
                                <td>${subjectData.transactionSize.toLocaleString()} SqFt</td>
                                <td class="adjustment-value">${adjustments.transactionSize}</td>
                            </tr>
                            <tr>
                                <td class="adjustment-label">Building Year</td>
                                <td>${comparableData.buildingYear}</td>
                                <td>${subjectData.buildingYear}</td>
                                <td class="adjustment-value">${adjustments.buildingYear}</td>
                            </tr>
                            <tr>
                                <td class="adjustment-label">Building Class</td>
                                <td>${comparableData.buildingClass}</td>
                                <td>${subjectData.buildingClass}</td>
                                <td class="adjustment-value">${adjustments.buildingClass}</td>
                            </tr>
                            <tr>
                                <td class="adjustment-label">Sublease</td>
                                <td>${comparableData.sublease}</td>
                                <td>${subjectData.sublease}</td>
                                <td class="adjustment-value">${adjustments.sublease}</td>
                            </tr>
                            <tr>
                                <td class="adjustment-label">Transaction Type</td>
                                <td>${comparableData.transactionType}</td>
                                <td>${subjectData.transactionType}</td>
                                <td class="adjustment-value">${adjustments.transactionType}</td>
                            </tr>
                            <tr>
                                <td class="adjustment-label">Total Adjustment:</td>
                                <td></td>
                                <td></td>
                                <td class="adjustment-value">${totalAdjustmentStr}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function calculateTimeAdjustment(subjectDate, comparableDate) {
            const [subYear, subQ] = subjectDate.split(' - Q');
            const [compYear, compQ] = comparableDate.split('-Q');
            const subQuarter = parseInt(subQ);
            const compQuarter = parseInt(compQ);
            const subYearNum = parseInt(subYear);
            const compYearNum = parseInt(compYear);
            
            const quartersDiff = (compYearNum - subYearNum) * 4 + (compQuarter - subQuarter);
            if (quartersDiff === 0) return '—';
            // More recent = positive adjustment
            return quartersDiff > 0 ? `+$${Math.min(quartersDiff * 0.25, 2.00).toFixed(2)}` : `-$${Math.min(Math.abs(quartersDiff) * 0.25, 2.00).toFixed(2)}`;
        }
        
        function calculateRentAdjustment(subjectRent, comparableRent) {
            const diff = comparableRent - subjectRent;
            if (Math.abs(diff) < 1) return '—';
            return diff > 0 ? `+$${Math.min(diff / 10, 2.00).toFixed(2)}` : `-$${Math.min(Math.abs(diff) / 10, 2.00).toFixed(2)}`;
        }
        
        function calculateSizeAdjustment(comparableSize, subjectSize) {
            const diff = comparableSize - subjectSize;
            if (Math.abs(diff) < 1000) return '—';
            // Larger transaction = negative adjustment (economies of scale)
            return diff > 0 ? `-$${Math.min(diff / 5000, 2.00).toFixed(2)}` : `+$${Math.min(Math.abs(diff) / 5000, 2.00).toFixed(2)}`;
        }
        
        function sortCompsData(data, column, direction) {
            return [...data].sort((a, b) => {
                const { prop: propA, lease: leaseA, impact: impactA } = a;
                const { prop: propB, lease: leaseB, impact: impactB } = b;
                let valA, valB;
                
                switch(column) {
                    case 'address':
                        valA = propA.address.toLowerCase();
                        valB = propB.address.toLowerCase();
                        break;
                    case 'impact':
                        valA = impactA || 0;
                        valB = impactB || 0;
                        break;
                    case 'transQtr':
                        valA = leaseA.transQtr;
                        valB = leaseB.transQtr;
                        break;
                    case 'tenant':
                        valA = leaseA.tenant.toLowerCase();
                        valB = leaseB.tenant.toLowerCase();
                        break;
                    case 'sqft':
                        valA = leaseA.sqft;
                        valB = leaseB.sqft;
                        break;
                    case 'currentRent':
                        valA = parseFloat(leaseA.currentRent.replace('$', ''));
                        valB = parseFloat(leaseB.currentRent.replace('$', ''));
                        break;
                    case 'adjustment':
                        // Sort by total adjusted value (currentRent + adjustment)
                        const rentA = parseFloat(leaseA.currentRent.replace('$', ''));
                        const adjA = parseFloat(leaseA.adjustment.replace('$', ''));
                        const rentB = parseFloat(leaseB.currentRent.replace('$', ''));
                        const adjB = parseFloat(leaseB.adjustment.replace('$', ''));
                        valA = rentA + adjA;
                        valB = rentB + adjB;
                        break;
                    case 'similarity':
                        valA = leaseA.similarity || 0;
                        valB = leaseB.similarity || 0;
                        break;
                    default:
                        return 0;
                }
                
                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }
        
        function renderCompsTable(page) {
            // Apply sorting to all data if active
            let dataToRender = compsFlat;
            if (compsSortColumn) {
                dataToRender = sortCompsData(compsFlat, compsSortColumn, compsSortDirection);
            }
            
            const start = (page - 1) * COMPs_PER_PAGE;
            const slice = dataToRender.slice(start, start + COMPs_PER_PAGE);
            
            // When sorted by non-address column, show addresses in all rows
            // When sorted by address or not sorted, use property-grouped view
            const showAddressInAllRows = compsSortColumn && compsSortColumn !== 'address';
            
            let html = '';
            
            if (showAddressInAllRows) {
                // When sorted: show address in every row
                slice.forEach((comp) => {
                    const { propIndex, lease, impact } = comp;
                    const prop = compsProperties[propIndex];
                    const pinColor = prop.isSubject ? '#E91E8C' : '#228FFF';
                    const pinHtml = prop.pinLabel
                        ? `<svg class="comps-map-pin" viewBox="0 0 24 36" width="20" height="26"><path d="M12 0C5.37 0 0 5.37 0 12c0 9 12 24 12 24s12-15 12-24C24 5.37 18.63 0 12 0z" fill="${pinColor}"/><text x="12" y="18" text-anchor="middle" fill="white" font-size="14" font-weight="bold">${prop.pinLabel}</text></svg>`
                        : `<svg class="comps-map-pin" viewBox="0 0 24 36" width="20" height="26"><path d="M12 0C5.37 0 0 5.37 0 12c0 9 12 24 12 24s12-15 12-24C24 5.37 18.63 0 12 0z" fill="${pinColor}"/><circle cx="12" cy="12" r="5" fill="white"/></svg>`;
                    
                    const tenantClass = lease.isSubject ? 'subject-tenant' : '';
                    const tenantHtml = lease.isSubject ? `${lease.tenant}<span class="subject-tag">Subject</span>` : lease.tenant;
                    
                    const addressCell = `<td class="address-cell"><div class="address-with-pin">${pinHtml}<span>${prop.address}</span></div></td>`;
                    const rowId = `lease-row-${propIndex}-${Date.now()}-${Math.random()}`;
                    const breakdownId = `breakdown-${propIndex}-${Date.now()}-${Math.random()}`;
                    const impactValue = impact || 0;
                    
                    // Don't show "See Why" button for subject lease
                    const detailsCell = lease.isSubject 
                        ? '<td></td>'
                        : `<td><button type="button" class="see-why-btn" data-breakdown-id="${breakdownId}"><span class="btn-text">See Why</span> <span class="btn-arrow">▾</span></button></td>`;
                    
                    // Format adjustment: "$60.00 (+$2.00)" where 60.00 is total adjusted value
                    const currentRentNum = parseFloat(lease.currentRent.replace('$', ''));
                    const adjustmentNum = parseFloat(lease.adjustment.replace('$', ''));
                    const totalAdjusted = currentRentNum + adjustmentNum;
                    const adjustmentSign = adjustmentNum >= 0 ? '+' : '';
                    const adjustmentFormatted = `$${totalAdjusted.toFixed(2)} <span class="adjustment-amount-tertiary">(${adjustmentSign}$${Math.abs(adjustmentNum).toFixed(2)})</span>`;
                    const similarityScore = lease.similarity || 0;
                    
                    html += `<tr class="lease-row" id="${rowId}">${addressCell}<td>${lease.transQtr}</td><td class="${tenantClass}">${tenantHtml}</td><td class="numeric">${lease.sqft.toLocaleString()}</td><td class="numeric">${lease.currentRent}</td><td class="numeric adjustment-cell">${adjustmentFormatted}</td><td class="numeric">${similarityScore}</td><td class="numeric">${impactValue.toFixed(1)}%</td>${detailsCell}</tr>`;
                    if (!lease.isSubject) {
                        html += `<tr class="adjustment-breakdown-row" id="${breakdownId}"><td class="adjustment-breakdown-cell" colspan="9">${generateAdjustmentBreakdown(lease)}</td></tr>`;
                    }
                });
            } else {
                // Default or sorted by address: group by property (show address only on first row of each property)
                const byProp = {};
                const propOrder = [];
                slice.forEach((comp) => {
                    const { propIndex, lease, impact } = comp;
                    if (!byProp[propIndex]) {
                        byProp[propIndex] = { prop: compsProperties[propIndex], leases: [] };
                        propOrder.push(propIndex);
                    }
                    byProp[propIndex].leases.push({ lease, impact });
                });
                
                propOrder.forEach(propIndex => {
                    const { prop, leases } = byProp[propIndex];
                    const pinColor = prop.isSubject ? '#E91E8C' : '#228FFF';
                    const pinHtml = prop.pinLabel
                        ? `<svg class="comps-map-pin" viewBox="0 0 24 36" width="20" height="26"><path d="M12 0C5.37 0 0 5.37 0 12c0 9 12 24 12 24s12-15 12-24C24 5.37 18.63 0 12 0z" fill="${pinColor}"/><text x="12" y="18" text-anchor="middle" fill="white" font-size="14" font-weight="bold">${prop.pinLabel}</text></svg>`
                        : `<svg class="comps-map-pin" viewBox="0 0 24 36" width="20" height="26"><path d="M12 0C5.37 0 0 5.37 0 12c0 9 12 24 12 24s12-15 12-24C24 5.37 18.63 0 12 0z" fill="${pinColor}"/><circle cx="12" cy="12" r="5" fill="white"/></svg>`;
                    
                    leases.forEach(({ lease: l, impact: impactValue }, leaseIndex) => {
                        const tenantClass = l.isSubject ? 'subject-tenant' : '';
                        const tenantHtml = l.isSubject ? `${l.tenant}<span class="subject-tag">Subject</span>` : l.tenant;
                        const addressCell = leaseIndex === 0 
                            ? `<td class="address-cell"><div class="address-with-pin">${pinHtml}<span>${prop.address}</span></div></td>`
                            : `<td class="address-cell"></td>`;
                        const rowId = `lease-row-${propIndex}-${leaseIndex}`;
                        const breakdownId = `breakdown-${propIndex}-${leaseIndex}`;
                        const isFirstLease = leaseIndex === 0;
                        const isLastLease = leaseIndex === leases.length - 1;
                        const groupClass = leases.length > 1 ? `property-group${isFirstLease ? ' group-start' : ''}${isLastLease ? ' group-end' : ''}` : '';
                        
                        // Don't show "See Why" button for subject lease
                        const detailsCell = l.isSubject 
                            ? '<td></td>'
                            : `<td><button type="button" class="see-why-btn" data-breakdown-id="${breakdownId}"><span class="btn-text">See Why</span> <span class="btn-arrow">▾</span></button></td>`;
                        
                        // Format adjustment: "$60.00 (+$2.00)" where 60.00 is total adjusted value
                        const currentRentNum = parseFloat(l.currentRent.replace('$', ''));
                        const adjustmentNum = parseFloat(l.adjustment.replace('$', ''));
                        const totalAdjusted = currentRentNum + adjustmentNum;
                        const adjustmentSign = adjustmentNum >= 0 ? '+' : '';
                        const adjustmentFormatted = `$${totalAdjusted.toFixed(2)} <span class="adjustment-amount-tertiary">(${adjustmentSign}$${Math.abs(adjustmentNum).toFixed(2)})</span>`;
                        const similarityScore = l.similarity || 0;
                        
                        html += `<tr class="lease-row ${groupClass}" id="${rowId}">${addressCell}<td>${l.transQtr}</td><td class="${tenantClass}">${tenantHtml}</td><td class="numeric">${l.sqft.toLocaleString()}</td><td class="numeric">${l.currentRent}</td><td class="numeric adjustment-cell">${adjustmentFormatted}</td><td class="numeric">${similarityScore}</td><td class="numeric">${(impactValue || 0).toFixed(1)}%</td>${detailsCell}</tr>`;
                        if (!l.isSubject) {
                            html += `<tr class="adjustment-breakdown-row ${groupClass}" id="${breakdownId}"><td class="adjustment-breakdown-cell" colspan="9">${generateAdjustmentBreakdown(l)}</td></tr>`;
                        }
                    });
                });
            }
            document.getElementById('comps-table-body').innerHTML = html;
            
            // Update sort indicators and table class
            const table = document.getElementById('comps-table');
            if (compsSortColumn && compsSortColumn !== 'address') {
                table?.classList.add('sorted');
            } else {
                table?.classList.remove('sorted');
            }
            
            // Update sort indicators
            document.querySelectorAll('.comps-table th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                const sortCol = th.getAttribute('data-sort');
                if (sortCol === compsSortColumn) {
                    th.classList.add(compsSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
            
            // Add event listeners for "See Why" buttons
            document.querySelectorAll('.see-why-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const breakdownId = this.getAttribute('data-breakdown-id');
                    const breakdownRow = document.getElementById(breakdownId);
                    const btnText = this.querySelector('.btn-text');
                    const btnArrow = this.querySelector('.btn-arrow');
                    if (breakdownRow) {
                        const isExpanded = breakdownRow.classList.contains('expanded');
                        breakdownRow.classList.toggle('expanded');
                        this.classList.toggle('expanded');
                        
                    // Update button text and row styling
                    const leaseRow = this.closest('.lease-row');
                    if (isExpanded) {
                        btnText.textContent = 'See Why';
                        btnArrow.textContent = '▾';
                        if (leaseRow) leaseRow.classList.remove('has-expanded-breakdown');
                    } else {
                        btnText.textContent = 'Collapse';
                        btnArrow.textContent = '▴';
                        if (leaseRow) leaseRow.classList.add('has-expanded-breakdown');
                    }
                    }
                });
            });
        }

        function renderCompsPagination(page) {
            const total = compsTotalPages;
            let html = `<button type="button" class="comps-pagination-btn" id="comps-prev" ${page <= 1 ? 'disabled' : ''}>‹ Previous</button><div class="comps-pagination-pages">`;
            for (let i = 1; i <= Math.min(5, total); i++) {
                html += `<span class="comps-pagination-page ${i === page ? 'active' : ''}" data-page="${i}">${i}</span>`;
            }
            html += `</div><button type="button" class="comps-pagination-btn" id="comps-next" ${page >= total ? 'disabled' : ''}>Next ›</button>`;
            const el = document.getElementById('comps-pagination');
            el.innerHTML = html;
            el.querySelector('#comps-prev')?.addEventListener('click', () => { if (page > 1) setCompsPage(page - 1); });
            el.querySelector('#comps-next')?.addEventListener('click', () => { if (page < total) setCompsPage(page + 1); });
            el.querySelectorAll('.comps-pagination-page').forEach(span => {
                span.addEventListener('click', () => setCompsPage(parseInt(span.getAttribute('data-page'), 10)));
            });
        }

        let compsCurrentPage = 1;
        function setCompsPage(p) {
            compsCurrentPage = p;
            renderCompsTable(p);
            renderCompsPagination(p);
        }
        
        function updateCompsTableSort(column) {
            if (compsSortColumn === column) {
                compsSortDirection = compsSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                compsSortColumn = column;
                compsSortDirection = 'asc';
            }
            // Reset to page 1 when sorting changes
            compsCurrentPage = 1;
            renderCompsTable(1);
            renderCompsPagination(1);
        }
        
        // Also allow sorting to be cleared (click same column 3 times or add a reset)
        // For now, clicking address when already sorted by address will toggle direction

        // Modal functionality
        function initModal() {
            const modal = document.getElementById('leases-modal');
            const openBtn = document.getElementById('view-comparable-leases-btn');
            const closeBtn = document.getElementById('modal-close');
            
            if (openBtn) {
                openBtn.addEventListener('click', () => {
                    if (modal) modal.classList.add('visible');
                });
            }
            
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    if (modal) modal.classList.remove('visible');
                });
            }
            
            // Close modal when clicking overlay
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('visible');
                    }
                });
            }
        }

        let tableSortingInitialized = false;
        
        // Initialize table sorting using event delegation
        function initTableSorting() {
            if (tableSortingInitialized) return;
            
            const table = document.getElementById('comps-table');
            if (!table) return;
            
            // Use event delegation on the table thead
            const thead = table.querySelector('thead');
            if (thead && !thead.hasAttribute('data-sort-initialized')) {
                thead.setAttribute('data-sort-initialized', 'true');
                thead.addEventListener('click', (e) => {
                    // Check if click is on a sortable header or its children
                    let th = e.target;
                    while (th && th !== thead) {
                        if (th.tagName === 'TH' && th.classList.contains('sortable')) {
                            const column = th.getAttribute('data-sort');
                            if (column) {
                                updateCompsTableSort(column);
                            }
                            break;
                        }
                        th = th.parentElement;
                    }
                });
                tableSortingInitialized = true;
            }
        }

        // Handle sticky Est. Starting Rent Today card visibility
        function updateStickyEstRentCard() {
            const estRentElement = document.querySelector('.est-rent-detail-item');
            const stickyCard = document.getElementById('sticky-est-rent-card');
            
            if (!estRentElement || !stickyCard) return;
            
            const rect = estRentElement.getBoundingClientRect();
            const topNavHeight = document.querySelector('.top-nav')?.offsetHeight || 0;
            
            // Check if the element is completely out of view (above the viewport)
            // Show sticky card when Est. Starting Rent Today is not visible at all
            const isVisible = rect.bottom > topNavHeight && rect.top < window.innerHeight;
            
            if (!isVisible) {
                stickyCard.classList.add('visible');
            } else {
                stickyCard.classList.remove('visible');
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            renderCompsTable(1);
            renderCompsPagination(1);
            initModal();
            // Initialize sorting - will be called again when tab is activated
            setTimeout(() => initTableSorting(), 100);
            const uc = document.getElementById('underlying-comps');
            if (uc?.classList.contains('active')) {
                initCompsMapIfNeeded();
                setTimeout(() => initTableSorting(), 200);
            }
            
            // Initialize sticky card visibility
            updateStickyEstRentCard();
            
            // Update sticky card on scroll
            window.addEventListener('scroll', updateStickyEstRentCard);
            window.addEventListener('resize', updateStickyEstRentCard);
            
            // Initialize chart tooltips
            initChartTooltips();
            
            // Handle "See Transaction Details" button click
            const stickyButton = document.querySelector('.sticky-est-rent-button');
            if (stickyButton) {
                stickyButton.addEventListener('click', () => {
                    switchToTab('transaction-details');
                    // Scroll to top of the tab content
                    const tabContent = document.getElementById('transaction-details');
                    if (tabContent) {
                        tabContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            }
        });
        
        // Initialize chart tooltips for Market Starting Rent Trend
        let chartTooltipsInitialized = false;
        function initChartTooltips() {
            if (chartTooltipsInitialized) return;
            
            const chartContainer = document.querySelector('.market-rent-chart-container');
            if (!chartContainer) return;
            
            // Create tooltip element if it doesn't exist
            let tooltip = document.getElementById('chart-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.className = 'chart-tooltip';
                tooltip.id = 'chart-tooltip';
                chartContainer.style.position = 'relative';
                chartContainer.appendChild(tooltip);
            }
            
            const originalRent = 55.00; // Original Starting Rent
            
            // Add event listeners to all chart dots (use event delegation to handle dynamically)
            const chartSvg = document.querySelector('.market-rent-line-chart');
            if (!chartSvg) return;
            
            chartSvg.addEventListener('mouseenter', (e) => {
                const dot = e.target.closest('.chart-dot');
                if (!dot) return;
                
                const rent = parseFloat(dot.getAttribute('data-rent'));
                const year = dot.getAttribute('data-year');
                
                if (rent && !isNaN(rent)) {
                    // Calculate % change from original rent
                    const percentChange = ((rent - originalRent) / originalRent) * 100;
                    const sign = percentChange >= 0 ? '+' : '';
                    const colorClass = percentChange >= 0 ? 'chart-tooltip-percentage' : '';
                    
                    // Update tooltip content
                    tooltip.innerHTML = `
                        <div><span class="chart-tooltip-value">$${rent.toFixed(2)}</span></div>
                        <div class="chart-tooltip-line"><span class="${colorClass}">${sign}${percentChange.toFixed(1)}%</span> vs. original</div>
                    `;
                    
                    // Position tooltip
                    const rect = dot.getBoundingClientRect();
                    const containerRect = chartContainer.getBoundingClientRect();
                    
                    // Calculate position relative to container
                    const x = rect.left - containerRect.left + (rect.width / 2);
                    const y = rect.top - containerRect.top - 10;
                    
                    tooltip.style.left = `${x}px`;
                    tooltip.style.top = `${y}px`;
                    tooltip.style.transform = 'translate(-50%, -100%)';
                    tooltip.classList.add('visible');
                }
            }, true);
            
            chartSvg.addEventListener('mouseleave', (e) => {
                const dot = e.target.closest('.chart-dot');
                if (dot) {
                    tooltip.classList.remove('visible');
                }
            }, true);
            
            // Also handle mouseout on dots directly
            const chartDots = document.querySelectorAll('.market-rent-line-chart .chart-dot');
            chartDots.forEach(dot => {
                dot.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('visible');
                });
            });
            
            chartTooltipsInitialized = true;
        }
    </script>
</body>
</html>
